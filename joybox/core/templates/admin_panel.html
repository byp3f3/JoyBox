{% extends 'base.html' %}

{% block title %}–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ - JoyBox{% endblock %}

{% block extra_css %}
<style>
    .admin-page {
        padding: 40px 0;
        min-height: calc(100vh - 200px);
    }
    
    .admin-header {
        text-align: center;
        margin-bottom: 30px;
    }
    
    .admin-header h1 {
        color: var(--primary-color);
        font-weight: 700;
        margin-bottom: 10px;
    }
    
    .admin-container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        padding: 30px;
    }
    
    .admin-nav {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
        flex-wrap: wrap;
    }
    
    .admin-nav a {
        display: block;
        padding: 12px 20px;
        background: #f8f9fa;
        color: var(--text-dark);
        text-decoration: none;
        border-radius: 8px;
        transition: all 0.3s ease;
        font-weight: 500;
    }
    
    .admin-nav a:hover,
    .admin-nav a.active {
        background: var(--primary-color);
        color: white;
    }
    
    .admin-content {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 25px;
        min-height: 300px;
    }
    
    .admin-section {
        display: none;
    }
    
    .admin-section.active {
        display: block;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        text-align: center;
    }
    
    .stat-card h3 {
        color: var(--primary-color);
        margin: 0 0 10px 0;
        font-size: 2rem;
    }
    
    .stat-card p {
        color: var(--text-light);
        margin: 0;
    }
    
    .btn-admin {
        background: linear-gradient(135deg, var(--primary-color), #b91c1c);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-admin:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
    }
    
    .admin-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    
    .admin-table th,
    .admin-table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #eee;
    }
    
    .admin-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: var(--text-dark);
    }
    
    .admin-table tr:hover {
        background: #f8f9fa;
    }
    
    .status-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    /* –°—Ç–∞—Ç—É—Å—ã –∑–∞–∫–∞–∑–æ–≤ */
    .status-oformlen {
        background: #e5e7eb;
        color: #374151;
    }
    .status-v-sborke {
        background: #fef3c7;
        color: #92400e;
    }
    .status-v-dostavku {
        background: #dbeafe;
        color: #1e40af;
    }
    .status-v-puti {
        background: #e0e7ff;
        color: #3730a3;
    }
    .status-dostavlen {
        background: #d1fae5;
        color: #065f46;
    }
    .status-poluchen {
        background: #a7f3d0;
        color: #047857;
    }
    .status-otmenen {
        background: #fee2e2;
        color: #991b1b;
    }
    
    /* –°—Ç–∏–ª–∏ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
    }
    
    .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 30px;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
    }
    
    .modal-header h3 {
        margin: 0;
        color: var(--primary-color);
    }
    
    .close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    
    .close:hover {
        color: black;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: var(--text-dark);
    }
    
    .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 1rem;
        box-sizing: border-box;
    }
    
    .form-control:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(220, 38, 38, 0.1);
    }
    
    .form-row {
        display: flex;
        gap: 15px;
    }
    
    .form-row .form-group {
        flex: 1;
    }
    
    .modal-footer {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid #eee;
    }
    
    .attribute-row {
        align-items: flex-end;
    }
    
    .attribute-row .form-group {
        margin-bottom: 0;
    }
    
    .attribute-row button {
        height: 38px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .form-text {
        color: #6c757d;
        font-size: 0.875em;
        margin-top: 5px;
        display: block;
    }
    
    .existing-images-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 8px;
    }
    
    .existing-images-list .img-item {
        position: relative;
        width: 80px;
        height: 80px;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid #eee;
    }
    
    .existing-images-list .img-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .existing-images-list .img-item .img-main-badge {
        position: absolute;
        top: 4px;
        left: 4px;
        background: var(--primary-color);
        color: white;
        font-size: 0.7rem;
        padding: 2px 6px;
        border-radius: 4px;
    }
    .order-items-cards {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 10px;
        margin-top: 8px;
    }
    .order-item-card {
        background: #f8f9fa;
        border: 1px solid #eee;
        border-radius: 8px;
        padding: 12px;
    }
    .order-item-card .order-item-name { font-weight: 600; margin-bottom: 4px; }
    .order-item-card .order-item-meta { font-size: 13px; color: #6c757d; margin-bottom: 4px; }
    .order-item-card .order-item-sum { font-weight: 600; color: var(--primary-color); }
    
    /* –°—Ç–∏–ª–∏ –≥–æ—Ä—è—á–∏—Ö –∫–ª–∞–≤–∏—à */
    .hotkey-hint {
        display: inline-block;
        background: rgba(0, 0, 0, 0.1);
        color: #666;
        font-size: 0.7rem;
        padding: 2px 6px;
        border-radius: 4px;
        margin-left: 8px;
        font-family: monospace;
        vertical-align: middle;
    }
    
    .admin-nav a .hotkey-hint {
        background: rgba(255, 255, 255, 0.2);
        color: inherit;
    }
    
    .admin-nav a:hover .hotkey-hint,
    .admin-nav a.active .hotkey-hint {
        background: rgba(255, 255, 255, 0.3);
    }
    
    .hotkeys-help {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        padding: 15px 20px;
        z-index: 100;
        max-width: 320px;
        display: none;
    }
    
    .hotkeys-help.visible {
        display: block;
    }
    
    .hotkeys-help h4 {
        margin: 0 0 12px 0;
        color: var(--primary-color);
        font-size: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .hotkeys-help .close-help {
        cursor: pointer;
        color: #aaa;
        font-size: 1.2rem;
    }
    
    .hotkeys-help .close-help:hover {
        color: #333;
    }
    
    .hotkeys-list {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 6px 12px;
        font-size: 0.85rem;
    }
    
    .hotkeys-list kbd {
        background: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 2px 6px;
        font-family: monospace;
        font-size: 0.8rem;
    }
    
    .hotkeys-toggle {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--primary-color);
        color: white;
        border: none;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        font-size: 1.2rem;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        z-index: 99;
        transition: all 0.3s ease;
    }
    
    .hotkeys-toggle:hover {
        transform: scale(1.1);
    }
    
    .hotkeys-toggle.hidden {
        display: none;
    }
    
    /* –°—Ç–∏–ª–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ */
    .analytics-filters {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        margin-bottom: 25px;
        padding: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        align-items: flex-end;
    }
    
    .analytics-filters .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    
    .analytics-filters label {
        font-size: 0.85rem;
        color: var(--text-light);
        font-weight: 500;
    }
    
    .analytics-filters input,
    .analytics-filters select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 0.9rem;
    }
    
    .analytics-filters .btn-group {
        display: flex;
        gap: 10px;
    }
    
    .analytics-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .summary-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        text-align: center;
    }
    
    .summary-card .value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 5px;
    }
    
    .summary-card .label {
        color: var(--text-light);
        font-size: 0.9rem;
    }
    
    .analytics-charts {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
    }
    
    .chart-container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    
    .chart-container h4 {
        margin: 0 0 15px 0;
        color: var(--text-dark);
        font-size: 1rem;
    }
    
    .chart-wrapper {
        position: relative;
        height: 300px;
    }
    
    .analytics-tables {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 25px;
    }
    
    .analytics-table-container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    
    .analytics-table-container h4 {
        margin: 0 0 15px 0;
        color: var(--text-dark);
        font-size: 1rem;
    }
    
    .analytics-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
    }
    
    .analytics-table th,
    .analytics-table td {
        padding: 10px 12px;
        text-align: left;
        border-bottom: 1px solid #eee;
    }
    
    .analytics-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: var(--text-dark);
    }
    
    .analytics-table tr:hover {
        background: #f8f9fa;
    }
    
    .analytics-table .number {
        text-align: right;
        font-family: monospace;
    }
    
    .export-buttons {
        display: flex;
        gap: 10px;
    }
    
    .btn-export {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .btn-export-csv {
        background: #28a745;
        color: white;
    }
    
    .btn-export-csv:hover {
        background: #218838;
    }
    
    .btn-export-excel {
        background: #217346;
        color: white;
    }
    
    .btn-export-excel:hover {
        background: #1e6b3e;
    }
    
    .analytics-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }
    
    .analytics-tab {
        padding: 10px 20px;
        background: #f0f0f0;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .analytics-tab.active {
        background: var(--primary-color);
        color: white;
    }
    
    .analytics-tab:hover:not(.active) {
        background: #e0e0e0;
    }
    
    .analytics-panel {
        display: none;
    }
    
    .analytics-panel.active {
        display: block;
    }
    
    .quick-period-buttons {
        display: flex;
        gap: 8px;
    }
    
    .quick-period-btn {
        padding: 6px 12px;
        background: #f0f0f0;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85rem;
        transition: all 0.2s ease;
    }
    
    .quick-period-btn:hover {
        background: #e0e0e0;
    }
    
    .quick-period-btn.active {
        background: var(--primary-color);
        color: white;
    }
    
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
    }
    
    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f0f0f0;
        border-top-color: var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-page">
    <div class="admin-header">
        <h1>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>
        <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–æ–π JoyBox</p>
    </div>
    
    <div class="admin-container">
        <div class="admin-nav">
            <a href="#" class="active" onclick="showAdminSection('dashboard')" data-section="dashboard">–î–∞—à–±–æ—Ä–¥ <span class="hotkey-hint">Alt+1</span></a>
            <a href="#" onclick="showAdminSection('products')" data-section="products">–ü—Ä–æ–¥—É–∫—Ç—ã <span class="hotkey-hint">Alt+2</span></a>
            <a href="#" onclick="showAdminSection('categories')" data-section="categories">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ <span class="hotkey-hint">Alt+3</span></a>
            <a href="#" onclick="showAdminSection('brands')" data-section="brands">–ë—Ä–µ–Ω–¥—ã <span class="hotkey-hint">Alt+4</span></a>
            <a href="#" class="admin-only-nav" data-section="users" onclick="showAdminSection('users')">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ <span class="hotkey-hint">Alt+5</span></a>
            <a href="#" onclick="showAdminSection('orders')" data-section="orders">–ó–∞–∫–∞–∑—ã <span class="hotkey-hint">Alt+6</span></a>
            <a href="#" onclick="showAdminSection('reviews')" data-section="reviews">–û—Ç–∑—ã–≤—ã <span class="hotkey-hint">Alt+7</span></a>
            <a href="#" class="admin-only-nav" data-section="logs" onclick="showAdminSection('logs')">–ñ—É—Ä–Ω–∞–ª—ã <span class="hotkey-hint">Alt+8</span></a>
            <a href="#" class="admin-only-nav" data-section="analytics" onclick="showAdminSection('analytics')">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ <span class="hotkey-hint">Alt+9</span></a>
            <a href="#" class="admin-only-nav" data-section="data-io" onclick="showAdminSection('data-io')">–ò–º–ø–æ—Ä—Ç/–≠–∫—Å–ø–æ—Ä—Ç</a>
            <a href="#" class="admin-only-nav" data-section="backups" onclick="showAdminSection('backups')">–ë—ç–∫–∞–ø—ã <span class="hotkey-hint">Alt+0</span></a>
        </div>
        
        <div class="admin-content">
            <div class="admin-section active" id="dashboard-section">
                <h2>–î–∞—à–±–æ—Ä–¥</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="totalProducts">0</h3>
                        <p>–ü—Ä–æ–¥—É–∫—Ç–æ–≤</p>
                    </div>
                    <div class="stat-card admin-only-section" id="dashboard-users-card">
                        <h3 id="totalUsers">0</h3>
                        <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="totalOrders">0</h3>
                        <p>–ó–∞–∫–∞–∑–æ–≤</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="totalRevenue">0 ‚ÇΩ</h3>
                        <p>–í—ã—Ä—É—á–∫–∞</p>
                    </div>
                </div>
                
                <button class="btn-admin" onclick="loadDashboardStats()">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
            </div>
            
            <div class="admin-section" id="products-section">
                <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏</h2>
                <button class="btn-admin" style="margin-bottom: 20px;" onclick="openProductModal()">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç</button>
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                            <th>–¶–µ–Ω–∞</th>
                            <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody">
                        <tr>
                            <td colspan="6" style="text-align: center;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td>
                        </tr>
                    </tbody>
                </table>
                <button class="btn-admin" onclick="loadProductsData()">–û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
            
            <div class="admin-section" id="categories-section">
                <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏</h2>
                <button class="btn-admin" style="margin-bottom: 20px;" onclick="openCategoryModal()">–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</button>
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="categoriesTableBody">
                        <tr><td colspan="4" style="text-align: center;">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                    </tbody>
                </table>
                <button class="btn-admin" onclick="loadCategoriesData()">–û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
            
            <div class="admin-section" id="brands-section">
                <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—Ä–µ–Ω–¥–∞–º–∏</h2>
                <button class="btn-admin" style="margin-bottom: 20px;" onclick="openBrandModal()">–î–æ–±–∞–≤–∏—Ç—å –±—Ä–µ–Ω–¥</button>
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th>–°—Ç—Ä–∞–Ω–∞</th>
                            <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="brandsTableBody">
                        <tr><td colspan="5" style="text-align: center;">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                    </tbody>
                </table>
                <button class="btn-admin" onclick="loadBrandsData()">–û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
            
            <div class="admin-section admin-only-section" id="users-section">
                <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h2>
                <button class="btn-admin" style="margin-bottom: 20px;" onclick="openUserModal()">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–ò–º—è</th>
                            <th>Email</th>
                            <th>–†–æ–ª—å</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr>
                            <td colspan="7" style="text-align: center;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td>
                        </tr>
                    </tbody>
                </table>
                <button class="btn-admin" onclick="loadUsersData()">–û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
            
            <div class="admin-section" id="orders-section">
                <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏</h2>
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            <th>–°—É–º–º–∞</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î–∞—Ç–∞</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody">
                        <tr>
                            <td colspan="6" style="text-align: center;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td>
                        </tr>
                    </tbody>
                </table>
                <button class="btn-admin" onclick="loadOrdersData()">–û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
            
            <div class="admin-section" id="reviews-section">
                <h2>–ú–æ–¥–µ—Ä–∞—Ü–∏—è –æ—Ç–∑—ã–≤–æ–≤</h2>
                <p style="color: var(--text-light); margin-bottom: 15px;">–ü—Ä–æ—Å–º–æ—Ç—Ä –∏ —É–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–¢–æ–≤–∞—Ä</th>
                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            <th>–†–µ–π—Ç–∏–Ω–≥</th>
                            <th>–¢–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞</th>
                            <th>–î–∞—Ç–∞</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="reviewsTableBody">
                        <tr><td colspan="7" style="text-align: center;">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                    </tbody>
                </table>
                <button class="btn-admin" onclick="loadReviewsData()">–û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
            
            <div class="admin-section admin-only-section" id="logs-section">
                <h2>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∂—É—Ä–Ω–∞–ª–æ–≤</h2>
                <p style="color: var(--text-light); margin-bottom: 15px;">–ó–∞–ø–∏—Å–∏ –∏–∑ –∂—É—Ä–Ω–∞–ª–∞ –∞—É–¥–∏—Ç–∞ (auditLog)</p>
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</th>
                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                            <th>–¢–∞–±–ª–∏—Ü–∞</th>
                            <th>ID –∑–∞–ø–∏—Å–∏</th>
                            <th>–ü—Ä–æ—Å–º–æ—Ç—Ä</th>
                        </tr>
                    </thead>
                    <tbody id="auditLogsTableBody">
                        <tr><td colspan="7" style="text-align: center;">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                    </tbody>
                </table>
                <button class="btn-admin" onclick="loadAuditLogsData()">–û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
            
            <!-- –†–∞–∑–¥–µ–ª –ò–º–ø–æ—Ä—Ç/–≠–∫—Å–ø–æ—Ä—Ç -->
            <div class="admin-section admin-only-section" id="data-io-section">
                <h2>–ò–º–ø–æ—Ä—Ç / –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h2>
                
                <!-- –≠–∫—Å–ø–æ—Ä—Ç -->
                <div style="background: var(--bg-light); border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid var(--border-muted);">
                    <h3 style="margin-top: 0; font-size: 1.1rem;">–≠–∫—Å–ø–æ—Ä—Ç —Ç–∞–±–ª–∏—Ü</h3>
                    <p style="color: var(--text-light); margin-bottom: 15px;">–°–∫–∞—á–∞–π—Ç–µ –¥–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü –≤ —Ñ–æ—Ä–º–∞—Ç–µ CSV –∏–ª–∏ SQL (INSERT-—Å–∫—Ä–∏–ø—Ç).</p>
                    <div style="display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap; margin-bottom: 15px;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="exportTable">–¢–∞–±–ª–∏—Ü–∞</label>
                            <select id="exportTable" class="form-control" style="min-width: 200px;">
                                <option value="product">–¢–æ–≤–∞—Ä—ã (product)</option>
                                <option value="category">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ (category)</option>
                                <option value="brand">–ë—Ä–µ–Ω–¥—ã (brand)</option>
                                <option value="order">–ó–∞–∫–∞–∑—ã (order)</option>
                                <option value="user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (user)</option>
                                <option value="review">–û—Ç–∑—ã–≤—ã (review)</option>
                                <option value="auditlog">–ñ—É—Ä–Ω–∞–ª –∞—É–¥–∏—Ç–∞ (auditLog)</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="exportFormat">–§–æ—Ä–º–∞—Ç</label>
                            <select id="exportFormat" class="form-control" style="min-width: 140px;">
                                <option value="csv">CSV</option>
                                <option value="sql">SQL (INSERT)</option>
                            </select>
                        </div>
                        <button class="btn-admin" onclick="exportTableData()" style="height: 42px;">–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                </div>
                
                <!-- –ò–º–ø–æ—Ä—Ç -->
                <div style="background: var(--bg-light); border-radius: 12px; padding: 20px; border: 1px solid var(--border-muted);">
                    <h3 style="margin-top: 0; font-size: 1.1rem;">–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –∏–∑ CSV</h3>
                    <p style="color: var(--text-light); margin-bottom: 15px;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ CSV-—Ñ–∞–π–ª –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –≤—ã–±—Ä–∞–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É. –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ CSV –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å—Ç–æ–ª–±—Ü–æ–≤.</p>
                    <div style="display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap; margin-bottom: 15px;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="importTable">–¢–∞–±–ª–∏—Ü–∞</label>
                            <select id="importTable" class="form-control" style="min-width: 200px;">
                                <option value="product">–¢–æ–≤–∞—Ä—ã (product)</option>
                                <option value="category">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ (category)</option>
                                <option value="brand">–ë—Ä–µ–Ω–¥—ã (brand)</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="importFile">CSV-—Ñ–∞–π–ª</label>
                            <input type="file" id="importFile" accept=".csv" class="form-control" style="min-width: 250px;">
                        </div>
                        <button class="btn-admin" onclick="importCsvData()" style="height: 42px;">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                    <div id="importResult" style="display: none; padding: 12px; border-radius: 8px; margin-top: 10px;"></div>
                </div>
            </div>
            
            <!-- –†–∞–∑–¥–µ–ª –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ -->
            <div class="admin-section admin-only-section" id="analytics-section">
                <h2>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –æ—Ç—á—ë—Ç—ã</h2>
                
                <!-- –§–∏–ª—å—Ç—Ä—ã -->
                <div class="analytics-filters">
                    <div class="filter-group">
                        <label>–ü–µ—Ä–∏–æ–¥</label>
                        <div class="quick-period-buttons">
                            <button class="quick-period-btn" onclick="setQuickPeriod('today')">–°–µ–≥–æ–¥–Ω—è</button>
                            <button class="quick-period-btn" onclick="setQuickPeriod('week')">–ù–µ–¥–µ–ª—è</button>
                            <button class="quick-period-btn active" onclick="setQuickPeriod('month')">–ú–µ—Å—è—Ü</button>
                            <button class="quick-period-btn" onclick="setQuickPeriod('quarter')">–ö–≤–∞—Ä—Ç–∞–ª</button>
                            <button class="quick-period-btn" onclick="setQuickPeriod('year')">–ì–æ–¥</button>
                            <button class="quick-period-btn" onclick="setQuickPeriod('all')">–í—Å—ë –≤—Ä–µ–º—è</button>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label for="analyticsDateFrom">–° –¥–∞—Ç—ã</label>
                        <input type="date" id="analyticsDateFrom">
                    </div>
                    <div class="filter-group">
                        <label for="analyticsDateTo">–ü–æ –¥–∞—Ç—É</label>
                        <input type="date" id="analyticsDateTo">
                    </div>
                    <div class="filter-group">
                        <label for="analyticsGroupBy">–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞</label>
                        <select id="analyticsGroupBy">
                            <option value="day">–ü–æ –¥–Ω—è–º</option>
                            <option value="week">–ü–æ –Ω–µ–¥–µ–ª—è–º</option>
                            <option value="month">–ü–æ –º–µ—Å—è—Ü–∞–º</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>&nbsp;</label>
                        <button class="btn-admin" onclick="loadAnalyticsData()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                    </div>
                </div>
                
                <!-- –¢–∞–±—ã –æ—Ç—á—ë—Ç–æ–≤ -->
                <div class="analytics-tabs">
                    <button class="analytics-tab active" onclick="switchAnalyticsTab('sales')">–û—Ç—á—ë—Ç –æ –ø—Ä–æ–¥–∞–∂–∞—Ö</button>
                    <button class="analytics-tab" onclick="switchAnalyticsTab('products')">–ü–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–æ–≤</button>
                    <button class="analytics-tab" onclick="switchAnalyticsTab('users')">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</button>
                    <button class="analytics-tab" onclick="switchAnalyticsTab('prices')">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω–∞–º–∏</button>
                </div>
                
                <!-- –ü–∞–Ω–µ–ª—å –æ—Ç—á—ë—Ç–∞ –æ –ø—Ä–æ–¥–∞–∂–∞—Ö -->
                <div class="analytics-panel active" id="sales-panel">
                    <!-- –°–≤–æ–¥–∫–∞ -->
                    <div class="analytics-summary">
                        <div class="summary-card">
                            <div class="value" id="analyticsTotalRevenue">0 ‚ÇΩ</div>
                            <div class="label">–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞</div>
                        </div>
                        <div class="summary-card">
                            <div class="value" id="analyticsTotalOrders">0</div>
                            <div class="label">–ó–∞–∫–∞–∑–æ–≤</div>
                        </div>
                        <div class="summary-card">
                            <div class="value" id="analyticsAvgCheck">0 ‚ÇΩ</div>
                            <div class="label">–°—Ä–µ–¥–Ω–∏–π —á–µ–∫</div>
                        </div>
                    </div>
                    
                    <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
                    <div class="analytics-charts">
                        <div class="chart-container">
                            <h4>–î–∏–Ω–∞–º–∏–∫–∞ –ø—Ä–æ–¥–∞–∂</h4>
                            <div class="chart-wrapper">
                                <canvas id="salesChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-container">
                            <h4>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h4>
                            <div class="chart-wrapper">
                                <canvas id="categoriesChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="analytics-charts">
                        <div class="chart-container">
                            <h4>–°—Ç–∞—Ç—É—Å—ã –∑–∞–∫–∞–∑–æ–≤</h4>
                            <div class="chart-wrapper">
                                <canvas id="statusChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-container">
                            <h4>–°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã</h4>
                            <div class="chart-wrapper">
                                <canvas id="paymentChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- –¢–∞–±–ª–∏—Ü—ã -->
                    <div class="analytics-tables">
                        <div class="analytics-table-container">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 style="margin: 0;">–ü—Ä–æ–¥–∞–∂–∏ –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º</h4>
                                <div class="export-buttons">
                                    <button class="btn-export btn-export-csv" onclick="exportReport('sales', 'csv')">
                                        üìÑ CSV
                                    </button>
                                    <button class="btn-export btn-export-excel" onclick="exportReport('sales', 'excel')">
                                        üìä Excel
                                    </button>
                                </div>
                            </div>
                            <div style="max-height: 400px; overflow-y: auto;">
                                <table class="analytics-table">
                                    <thead>
                                        <tr>
                                            <th>–ü–µ—Ä–∏–æ–¥</th>
                                            <th class="number">–í—ã—Ä—É—á–∫–∞</th>
                                            <th class="number">–ó–∞–∫–∞–∑–æ–≤</th>
                                            <th class="number">–°—Ä–µ–¥–Ω–∏–π —á–µ–∫</th>
                                        </tr>
                                    </thead>
                                    <tbody id="salesByPeriodTable">
                                        <tr><td colspan="4" style="text-align: center;">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="analytics-table-container">
                            <h4>–ü—Ä–æ–¥–∞–∂–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h4>
                            <div style="max-height: 400px; overflow-y: auto;">
                                <table class="analytics-table">
                                    <thead>
                                        <tr>
                                            <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                            <th class="number">–ü—Ä–æ–¥–∞–Ω–æ</th>
                                            <th class="number">–í—ã—Ä—É—á–∫–∞</th>
                                        </tr>
                                    </thead>
                                    <tbody id="salesByCategoryTable">
                                        <tr><td colspan="3" style="text-align: center;">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- –ü–∞–Ω–µ–ª—å –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏ —Ç–æ–≤–∞—Ä–æ–≤ -->
                <div class="analytics-panel" id="products-panel">
                    <!-- –¢–∞–±–ª–∏—Ü—ã —Ç–æ–≤–∞—Ä–æ–≤ -->
                    <div class="analytics-tables">
                        <div class="analytics-table-container">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 style="margin: 0;">–¢–æ–ø –ø—Ä–æ–¥–∞–≤–∞–µ–º—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤</h4>
                                <div class="export-buttons">
                                    <button class="btn-export btn-export-csv" onclick="exportReport('products', 'csv')">
                                        üìÑ CSV
                                    </button>
                                    <button class="btn-export btn-export-excel" onclick="exportReport('products', 'excel')">
                                        üìä Excel
                                    </button>
                                </div>
                            </div>
                            <div style="max-height: 500px; overflow-y: auto;">
                                <table class="analytics-table">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>–¢–æ–≤–∞—Ä</th>
                                            <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                            <th class="number">–ü—Ä–æ–¥–∞–Ω–æ</th>
                                            <th class="number">–í—ã—Ä—É—á–∫–∞</th>
                                        </tr>
                                    </thead>
                                    <tbody id="topSellingTable">
                                        <tr><td colspan="5" style="text-align: center;">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="analytics-table-container">
                            <h4>–¢–æ–≤–∞—Ä—ã —Å –Ω–∞–∏–≤—ã—Å—à–∏–º —Ä–µ–π—Ç–∏–Ω–≥–æ–º</h4>
                            <div style="max-height: 500px; overflow-y: auto;">
                                <table class="analytics-table">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>–¢–æ–≤–∞—Ä</th>
                                            <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                            <th class="number">–†–µ–π—Ç–∏–Ω–≥</th>
                                            <th class="number">–û—Ç–∑—ã–≤–æ–≤</th>
                                        </tr>
                                    </thead>
                                    <tbody id="topRatedTable">
                                        <tr><td colspan="5" style="text-align: center;">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- –ì—Ä–∞—Ñ–∏–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ -->
                    <div class="analytics-charts" style="margin-top: 25px;">
                        <div class="chart-container">
                            <h4>–¢–æ–ø-10 –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –ø—Ä–æ–¥–∞–∂</h4>
                            <div class="chart-wrapper">
                                <canvas id="topProductsChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-container">
                            <h4>–¢–æ–ø-10 –ø–æ –≤—ã—Ä—É—á–∫–µ</h4>
                            <div class="chart-wrapper">
                                <canvas id="topRevenueChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- –¢–æ–≤–∞—Ä—ã —Å –Ω–∏–∑–∫–∏–º –æ—Å—Ç–∞—Ç–∫–æ–º -->
                    <div class="analytics-tables" style="margin-top: 25px;">
                        <div class="analytics-table-container" style="grid-column: 1 / -1;">
                            <h4 style="color: #dc2626;">‚ö†Ô∏è –¢–æ–≤–∞—Ä—ã —Å –Ω–∏–∑–∫–∏–º –æ—Å—Ç–∞—Ç–∫–æ–º (–º–µ–Ω–µ–µ 5 —à—Ç.)</h4>
                            <div style="max-height: 300px; overflow-y: auto;">
                                <table class="analytics-table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>–¢–æ–≤–∞—Ä</th>
                                            <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                            <th class="number">–û—Å—Ç–∞—Ç–æ–∫</th>
                                            <th class="number">–¶–µ–Ω–∞</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lowStockTable">
                                        <tr><td colspan="5" style="text-align: center;">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- –ü–∞–Ω–µ–ª—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–∏–∑ SQL-–ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è v_user_activity) -->
                <div class="analytics-panel" id="users-panel">
                    <div class="analytics-tables">
                        <div class="analytics-table-container" style="grid-column: 1 / -1;">
                            <h4>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h4>
                            <div style="max-height: 600px; overflow-y: auto;">
                                <table class="analytics-table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                            <th>Email</th>
                                            <th>–†–æ–ª—å</th>
                                            <th class="number">–ó–∞–∫–∞–∑–æ–≤</th>
                                            <th class="number">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ</th>
                                            <th class="number">–û—Ç–∑—ã–≤–æ–≤</th>
                                            <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                                        </tr>
                                    </thead>
                                    <tbody id="userActivityTable">
                                        <tr><td colspan="8" style="text-align: center;">–ù–∞–∂–º–∏—Ç–µ ¬´–ü—Ä–∏–º–µ–Ω–∏—Ç—å¬ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ü–µ–Ω–∞–º–∏ (—Ö—Ä–∞–Ω–∏–º–∞—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ sp_adjust_prices_by_category) -->
                <div class="analytics-panel" id="prices-panel">
                    <div class="analytics-tables">
                        <div class="analytics-table-container" style="grid-column: 1 / -1;">
                            <h4>–ü–∞–∫–µ—Ç–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</h4>
                            <p style="color: #666; margin-bottom: 20px;">–ü—Ä–∏–º–µ–Ω—è–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã –∫–æ –≤—Å–µ–º —Ç–æ–≤–∞—Ä–∞–º –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.</p>
                            <div style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap; margin-bottom: 20px;">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label for="priceAdjustCategory">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                                    <select id="priceAdjustCategory" class="form-control" style="min-width: 200px;">
                                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label for="priceAdjustPercent">–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã (%)</label>
                                    <input type="number" id="priceAdjustPercent" class="form-control" style="width: 150px;" step="0.01" min="-90" max="500" placeholder="–Ω–∞–ø—Ä. -10 –∏–ª–∏ 15">
                                </div>
                                <button class="btn-admin" onclick="applyPriceAdjustment()" style="height: 42px;">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                            </div>
                            <div id="priceAdjustResult" style="display: none; padding: 12px; border-radius: 8px; margin-bottom: 15px;"></div>
                            <div style="background: #fef3c7; padding: 12px; border-radius: 8px; border: 1px solid #f59e0b;">
                                <strong>–ü—Ä–∏–º–µ—Ä—ã:</strong><br>
                                <code>-10</code> ‚Äî —Å–∫–∏–¥–∫–∞ 10% –Ω–∞ –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏<br>
                                <code>15</code> ‚Äî –Ω–∞—Ü–µ–Ω–∫–∞ 15% –Ω–∞ –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏<br>
                                <code>-25.5</code> ‚Äî —Å–∫–∏–¥–∫–∞ 25.5%
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- –†–∞–∑–¥–µ–ª –ë—ç–∫–∞–ø—ã -->
            <div class="admin-section admin-only-section" id="backups-section">
                <h2>–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ</h2>
                
                <!-- –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ -->
                <div style="background: var(--bg-light); border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid var(--border-muted);">
                    <h3 style="margin-top: 0; font-size: 1.1rem;">–°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é</h3>
                    <div style="display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="backupFormat">–§–æ—Ä–º–∞—Ç</label>
                            <select id="backupFormat" class="form-control" style="min-width: 180px;">
                                <option value="custom">Custom (.backup) ‚Äî —Å–∂–∞—Ç—ã–π</option>
                                <option value="sql">SQL (.sql) ‚Äî —Ç–µ–∫—Å—Ç–æ–≤—ã–π</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>
                                <input type="checkbox" id="backupDataOnly" style="margin-right: 6px;">
                                –¢–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ
                            </label>
                        </div>
                        <button class="btn-admin" onclick="createBackup()" id="createBackupBtn" style="height: 42px;">
                            –°–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø
                        </button>
                    </div>
                    <div id="backupCreateResult" style="display: none; padding: 10px; border-radius: 8px; margin-top: 12px;"></div>
                </div>
                
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç–µ -->
                <div style="background: #eff6ff; border: 1px solid #3b82f6; border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                    <h4 style="margin-top: 0; color: #1d4ed8;">–†–µ–≥–ª–∞–º–µ–Ω—Ç —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è</h4>
                    <ul style="margin: 0; padding-left: 20px; color: #1e40af; line-height: 1.8;">
                        <li><strong>–ï–∂–µ–¥–Ω–µ–≤–Ω–æ</strong> ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –±—ç–∫–∞–ø —á–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç <code>scripts/backup.bat</code> (–ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á Windows / cron)</li>
                        <li><strong>–ü–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏</strong> ‚Äî —Ä—É—á–Ω–æ–π –±—ç–∫–∞–ø —á–µ—Ä–µ–∑ —ç—Ç—É –ø–∞–Ω–µ–ª—å –∏–ª–∏ –∫–æ–º–∞–Ω–¥—É <code>python manage.py backup_db</code></li>
                        <li><strong>–•—Ä–∞–Ω–µ–Ω–∏–µ</strong> ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–µ <span id="backupMaxCount">10</span> –∫–æ–ø–∏–π, —Å—Ç–∞—Ä—ã–µ —É–¥–∞–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</li>
                        <li><strong>–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ</strong> ‚Äî —á–µ—Ä–µ–∑ –ø–∞–Ω–µ–ª—å, —Å–∫—Ä–∏–ø—Ç <code>scripts/restore.bat</code> –∏–ª–∏ <code>python manage.py restore_db --latest</code></li>
                    </ul>
                </div>
                
                <!-- –°–ø–∏—Å–æ–∫ –±—ç–∫–∞–ø–æ–≤ -->
                <h3>–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏</h3>
                <button class="btn-admin" style="margin-bottom: 15px;" onclick="loadBackupsList()">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
                <div id="backupsTableContainer">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>–§–∞–π–ª</th>
                                <th>–§–æ—Ä–º–∞—Ç</th>
                                <th>–†–∞–∑–º–µ—Ä</th>
                                <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="backupsTableBody">
                            <tr><td colspan="5" style="text-align: center;">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–µ—Ç–∞–ª–µ–π –∂—É—Ä–Ω–∞–ª–∞ –∞—É–¥–∏—Ç–∞ -->
    <div id="auditLogModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>–ó–∞–ø–∏—Å—å –∂—É—Ä–Ω–∞–ª–∞ –∞—É–¥–∏—Ç–∞</h3>
                <span class="close" onclick="closeAuditLogModal()">&times;</span>
            </div>
            <div id="auditLogDetail" style="padding: 15px;">
                <div style="display: grid; grid-template-columns: 140px 1fr; gap: 8px 12px; margin-bottom: 20px;">
                    <strong>ID:</strong> <span id="auditDetailId"></span>
                    <strong>–î–∞—Ç–∞:</strong> <span id="auditDetailDate"></span>
                    <strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> <span id="auditDetailUser"></span>
                    <strong>–î–µ–π—Å—Ç–≤–∏–µ:</strong> <span id="auditDetailAction"></span>
                    <strong>–¢–∞–±–ª–∏—Ü–∞:</strong> <span id="auditDetailTable"></span>
                    <strong>ID –∑–∞–ø–∏—Å–∏:</strong> <span id="auditDetailRecordId"></span>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <h4 style="margin: 0 0 8px 0; color: #dc2626;">–°—Ç–∞—Ä—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è</h4>
                        <pre id="auditDetailOld" style="background: var(--bg-light); border: 1px solid var(--border-muted); border-radius: 8px; padding: 12px; white-space: pre-wrap; word-break: break-word; max-height: 400px; overflow-y: auto; font-size: 0.85rem;">‚Äî</pre>
                    </div>
                    <div>
                        <h4 style="margin: 0 0 8px 0; color: #10b981;">–ù–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è</h4>
                        <pre id="auditDetailNew" style="background: var(--bg-light); border: 1px solid var(--border-muted); border-radius: 8px; padding: 12px; white-space: pre-wrap; word-break: break-word; max-height: 400px; overflow-y: auto; font-size: 0.85rem;">‚Äî</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ç–æ–≤–∞—Ä–∞ -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç</h3>
                <span class="close" onclick="closeProductModal()">&times;</span>
            </div>
            <form id="productForm">
                <input type="hidden" id="productId">
                <div class="form-group">
                    <label for="productName">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ *</label>
                    <input type="text" id="productName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="productDescription">–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞</label>
                    <textarea id="productDescription" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="categoryId">–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
                        <select id="categoryId" class="form-control" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="brandId">–ë—Ä–µ–Ω–¥ *</label>
                        <select id="brandId" class="form-control" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–µ–Ω–¥</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="price">–¶–µ–Ω–∞ *</label>
                        <input type="number" id="price" class="form-control" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="quantity">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ *</label>
                        <input type="number" id="quantity" class="form-control" min="0" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="ageRating">–í–æ–∑—Ä–∞—Å—Ç–Ω–æ–π —Ä–µ–π—Ç–∏–Ω–≥ *</label>
                        <select id="ageRating" class="form-control" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–∑—Ä–∞—Å—Ç–Ω–æ–π —Ä–µ–π—Ç–∏–Ω–≥</option>
                            <option value="0">0+</option>
                            <option value="1">1+</option>
                            <option value="2">2+</option>
                            <option value="3">3+</option>
                            <option value="4">4+</option>
                            <option value="5">5+</option>
                            <option value="6">6+</option>
                            <option value="7">7+</option>
                            <option value="8">8+</option>
                            <option value="12">12+</option>
                            <option value="16">16+</option>
                            <option value="18">18+</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="weightKg">–í–µ—Å (–∫–≥)</label>
                        <input type="number" id="weightKg" class="form-control" step="0.01" min="0">
                    </div>
                </div>
                <div class="form-group">
                    <label for="dimensions">–†–∞–∑–º–µ—Ä—ã</label>
                    <input type="text" id="dimensions" class="form-control" placeholder="–î x –® x –í —Å–º">
                </div>
                <div class="form-group" id="existingImagesBlock" style="display: none;">
                    <label>–¢–µ–∫—É—â–∏–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</label>
                    <div id="existingImagesList" class="existing-images-list"></div>
                </div>
                <div class="form-group">
                    <label for="productImages">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Ç–æ–≤–∞—Ä–∞</label>
                    <input type="file" id="productImages" class="form-control" accept="image/*" multiple>
                    <small class="form-text">–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω—É –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π —Ç–æ–≤–∞—Ä–∞ (–ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ ‚Äî –¥–æ–±–∞–≤—è—Ç—Å—è –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º)</small>
                </div>
                <div class="form-group">
                    <label>–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Ç–æ–≤–∞—Ä–∞</label>
                    <div id="attributesContainer">
                        <div class="attribute-row form-row" style="margin-bottom: 10px;">
                            <div class="form-group">
                                <input type="text" class="form-control attribute-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏">
                            </div>
                            <div class="form-group">
                                <input type="text" class="form-control attribute-value" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ">
                            </div>
                            <div class="form-group">
                                <input type="text" class="form-control attribute-unit" placeholder="–ï–¥. –∏–∑–º–µ—Ä–µ–Ω–∏—è (–æ–ø—Ü.)">
                            </div>
                            <div class="form-group">
                                <button type="button" class="btn-admin" style="padding: 5px 10px; background: #28a745;" onclick="addAttributeRow()">+</button>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn-admin" style="margin-top: 10px; background: #17a2b8;" onclick="addAttributeRow()">–î–æ–±–∞–≤–∏—Ç—å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫—É</button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-admin" style="background: #6c757d;" onclick="closeProductModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn-admin">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="userModalTitle">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
                <span class="close" onclick="closeUserModal()">&times;</span>
            </div>
            <form id="userForm">
                <input type="hidden" id="userId">
                <div class="form-row">
                    <div class="form-group">
                        <label for="userFirstName">–ò–º—è *</label>
                        <input type="text" id="userFirstName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="userLastName">–§–∞–º–∏–ª–∏—è *</label>
                        <input type="text" id="userLastName" class="form-control" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="userMiddleName">–û—Ç—á–µ—Å—Ç–≤–æ</label>
                    <input type="text" id="userMiddleName" class="form-control">
                </div>
                <div class="form-group">
                    <label for="userEmail">Email *</label>
                    <input type="email" id="userEmail" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="userPhone">–¢–µ–ª–µ—Ñ–æ–Ω *</label>
                    <input type="tel" id="userPhone" class="form-control" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="userBirthDate">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è *</label>
                        <input type="date" id="userBirthDate" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="userRoleId">–†–æ–ª—å *</label>
                        <select id="userRoleId" class="form-control" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="userPassword">–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="userPassword" class="form-control" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å">
                    <small class="form-text">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å –ø–∞—Ä–æ–ª—å</small>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-admin" style="background: #6c757d;" onclick="closeUserModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn-admin">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
    <div id="categoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="categoryModalTitle">–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h3>
                <span class="close" onclick="closeCategoryModal()">&times;</span>
            </div>
            <form id="categoryForm">
                <input type="hidden" id="editCategoryId">
                <div class="form-group">
                    <label for="categoryName">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ *</label>
                    <input type="text" id="categoryName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="categoryDescription">–û–ø–∏—Å–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ *</label>
                    <textarea id="categoryDescription" class="form-control" rows="3" required></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-admin" style="background: #6c757d;" onclick="closeCategoryModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn-admin">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –±—Ä–µ–Ω–¥–∞ -->
    <div id="brandModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="brandModalTitle">–î–æ–±–∞–≤–∏—Ç—å –±—Ä–µ–Ω–¥</h3>
                <span class="close" onclick="closeBrandModal()">&times;</span>
            </div>
            <form id="brandForm">
                <input type="hidden" id="editBrandId">
                <div class="form-group">
                    <label for="brandName">–ù–∞–∑–≤–∞–Ω–∏–µ –±—Ä–µ–Ω–¥–∞ *</label>
                    <input type="text" id="brandName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="brandCountry">–°—Ç—Ä–∞–Ω–∞ –±—Ä–µ–Ω–¥–∞ *</label>
                    <input type="text" id="brandCountry" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="brandDescription">–û–ø–∏—Å–∞–Ω–∏–µ –±—Ä–µ–Ω–¥–∞ *</label>
                    <textarea id="brandDescription" class="form-control" rows="3" required></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-admin" style="background: #6c757d;" onclick="closeBrandModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn-admin">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- –ü–∞–Ω–µ–ª—å —Å–ø—Ä–∞–≤–∫–∏ –ø–æ –≥–æ—Ä—è—á–∏–º –∫–ª–∞–≤–∏—à–∞–º -->
    <button class="hotkeys-toggle" onclick="toggleHotkeysHelp()" title="–ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ (Alt+H)">‚å®</button>
    <div id="hotkeysHelp" class="hotkeys-help">
        <h4>
            –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
            <span class="close-help" onclick="toggleHotkeysHelp()">&times;</span>
        </h4>
        <div class="hotkeys-list">
            <kbd>Alt+1</kbd> <span>–î–∞—à–±–æ—Ä–¥</span>
            <kbd>Alt+2</kbd> <span>–ü—Ä–æ–¥—É–∫—Ç—ã</span>
            <kbd>Alt+3</kbd> <span>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</span>
            <kbd>Alt+4</kbd> <span>–ë—Ä–µ–Ω–¥—ã</span>
            <kbd>Alt+5</kbd> <span>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</span>
            <kbd>Alt+6</kbd> <span>–ó–∞–∫–∞–∑—ã</span>
            <kbd>Alt+7</kbd> <span>–û—Ç–∑—ã–≤—ã</span>
            <kbd>Alt+8</kbd> <span>–ñ—É—Ä–Ω–∞–ª—ã</span>
            <kbd>Alt+9</kbd> <span>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</span>
            <kbd>Alt+N</kbd> <span>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç</span>
            <kbd>Alt+R</kbd> <span>–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</span>
            <kbd>Alt+S</kbd> <span>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ—Ä–º—É</span>
            <kbd>Esc</kbd> <span>–ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ</span>
            <kbd>Alt+H</kbd> <span>–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏</span>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–µ—Ç–∞–ª–µ–π –∑–∞–∫–∞–∑–∞ -->
    <div id="orderModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>–ó–∞–∫–∞–∑ <span id="orderModalOrderId"></span></h3>
                <span class="close" onclick="closeOrderModal()">&times;</span>
            </div>
            <div id="orderModalBody" style="max-height: 70vh; overflow-y: auto;">
                <input type="hidden" id="orderModalOrderPk">
                <div class="form-group">
                    <label>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</label>
                    <p id="orderModalUser"></p>
                </div>
                <div class="form-group">
                    <label>–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</label>
                    <p id="orderModalAddress"></p>
                </div>
                <div class="form-group">
                    <label>–î–æ—Å—Ç–∞–≤–∫–∞ / –û–ø–ª–∞—Ç–∞</label>
                    <p id="orderModalDeliveryPayment"></p>
                </div>
                <div class="form-group">
                    <label>–°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞</label>
                    <div id="orderModalItems" class="order-items-cards"></div>
                </div>
                <div class="form-group">
                    <label>–ò—Ç–æ–≥–æ</label>
                    <p id="orderModalTotal" style="font-weight: 700; font-size: 1.1rem;"></p>
                </div>
                <div class="form-group">
                    <label for="orderModalStatus">–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞</label>
                    <select id="orderModalStatus" class="form-control"></select>
                </div>
                <div class="form-group" id="orderModalNoteBlock" style="display: none;">
                    <label>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</label>
                    <p id="orderModalNote"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-admin" style="background: #6c757d;" onclick="closeOrderModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
                <button type="button" class="btn-admin" id="btnMarkPaid" style="background: #28a745; display: none;" onclick="markOrderAsPaid()">–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–π</button>
                <button type="button" class="btn-admin" onclick="saveOrderStatus()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–π -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    const authToken = localStorage.getItem('authToken');
    if (!authToken) {
        window.location.href = '/login/';
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    fetch('/api/admin/panel/', {
        headers: {
            'Authorization': `Token ${authToken}`
        }
    })
    .then(response => {
        if (!response.ok) {
            // –ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –≤—Ö–æ–¥
            localStorage.removeItem('authToken');
            window.location.href = '/login/';
            return;
        }
        return response.json();
    })
    .then(data => {
        if (data.redirect) {
            window.location.href = data.redirect;
            return;
        }
        // –†–∞–∑–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø—Ä–∞–≤: –º–µ–Ω–µ–¥–∂–µ—Ä –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Ä–∞–∑–¥–µ–ª—ã
        const isAdmin = data.is_admin === true;
        if (!isAdmin) {
            document.querySelectorAll('.admin-only-nav').forEach(el => { el.style.display = 'none'; });
            document.querySelectorAll('.admin-only-section').forEach(el => { el.style.display = 'none'; });
        }
        loadDashboardStats();
    })
    .catch(error => {
        console.error('Error verifying admin access:', error);
        localStorage.removeItem('authToken');
        window.location.href = '/login/';
    });
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–∞–Ω–µ–ª–∏
    function loadDashboardStats() {
        fetch('/api/admin/dashboard/', {
            headers: {
                'Authorization': `Token ${authToken}`
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            document.getElementById('totalProducts').textContent = data.total_products;
            document.getElementById('totalUsers').textContent = data.total_users;
            document.getElementById('totalOrders').textContent = data.total_orders;
            document.getElementById('totalRevenue').textContent = data.total_revenue + ' ‚ÇΩ';
        })
        .catch(error => {
            console.error('Error loading dashboard stats:', error);
        });
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
    function loadProductsData() {
        fetch('/api/admin/products/', {
            headers: {
                'Authorization': `Token ${authToken}`
            }
        })
        .then(response => response.json())
        .then(data => {
            const productsTableBody = document.getElementById('productsTableBody');
            if (data.length === 0) {
                productsTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">–ù–µ—Ç –ø—Ä–æ–¥—É–∫—Ç–æ–≤</td></tr>';
                return;
            }
            
            let html = '';
            data.forEach(product => {
                html += `
                    <tr>
                        <td>${product.productId}</td>
                        <td>${product.productName}</td>
                        <td>${product.category ? product.category.categoryName : ''}</td>
                        <td>${product.price} ‚ÇΩ</td>
                        <td>${product.quantity}</td>
                        <td>
                            <button class="btn-admin" style="padding: 5px 10px; font-size: 0.9rem; margin-right: 5px;" onclick="openProductModal(${product.productId})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                            <button class="btn-admin" style="padding: 5px 10px; font-size: 0.9rem; background: #ef4444;" onclick="deleteProduct(${product.productId})">–£–¥–∞–ª–∏—Ç—å</button>
                        </td>
                    </tr>
                `;
            });
            productsTableBody.innerHTML = html;
        })
        .catch(error => {
            console.error('Error loading products:', error);
            document.getElementById('productsTableBody').innerHTML = '<tr><td colspan="6" style="text-align: center;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</td></tr>';
        });
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    function loadUsersData() {
        fetch('/api/admin/users/', {
            headers: {
                'Authorization': `Token ${authToken}`
            }
        })
        .then(response => response.json())
        .then(data => {
            const usersTableBody = document.getElementById('usersTableBody');
            if (data.length === 0) {
                usersTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</td></tr>';
                return;
            }
            const isActive = (u) => u.is_active !== false;
            let html = '';
            data.forEach(user => {
                const active = isActive(user);
                const statusText = active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω';
                const statusClass = active ? 'status-poluchen' : 'status-otmenen';
                const blockBtn = active
                    ? `<button class="btn-admin" style="padding: 5px 10px; font-size: 0.9rem; background: #ef4444;" onclick="blockUser(${user.userId})">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>`
                    : `<button class="btn-admin" style="padding: 5px 10px; font-size: 0.9rem; background: #28a745;" onclick="unblockUser(${user.userId})">–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>`;
                html += `
                    <tr>
                        <td>${user.userId}</td>
                        <td>${user.firstName} ${user.lastName}${user.middleName ? ' ' + user.middleName : ''}</td>
                        <td>${user.email}</td>
                        <td>${user.roleName || '–ü–æ–∫—É–ø–∞—Ç–µ–ª—å'}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${user.createdAt ? new Date(user.createdAt).toLocaleDateString('ru-RU') : 'N/A'}</td>
                        <td>
                            <button class="btn-admin" style="padding: 5px 10px; font-size: 0.9rem; margin-right: 5px;" onclick="openUserModal(${user.userId})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                            ${blockBtn}
                        </td>
                    </tr>
                `;
            });
            usersTableBody.innerHTML = html;
        })
        .catch(error => {
            console.error('Error loading users:', error);
            document.getElementById('usersTableBody').innerHTML = '<tr><td colspan="7" style="text-align: center;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</td></tr>';
        });
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤
    function loadOrdersData() {
        fetch('/api/admin/orders/', {
            headers: {
                'Authorization': `Token ${authToken}`
            }
        })
        .then(response => response.json())
        .then(data => {
            const ordersTableBody = document.getElementById('ordersTableBody');
            if (data.length === 0) {
                ordersTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</td></tr>';
                return;
            }
            
            let html = '';
            const statusClassMap = {
                '–û—Ñ–æ—Ä–º–ª–µ–Ω': 'status-oformlen',
                '–í —Å–±–æ—Ä–∫–µ': 'status-v-sborke',
                '–ü–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ –¥–æ—Å—Ç–∞–≤–∫—É': 'status-v-dostavku',
                '–í –ø—É—Ç–∏': 'status-v-puti',
                '–î–æ—Å—Ç–∞–≤–ª–µ–Ω': 'status-dostavlen',
                '–ü–æ–ª—É—á–µ–Ω': 'status-poluchen',
                '–û—Ç–º–µ–Ω–µ–Ω': 'status-otmenen'
            };
            data.forEach(order => {
                const statusClass = statusClassMap[order.status] || 'status-oformlen';
                
                html += `
                    <tr>
                        <td>${order.orderId}</td>
                        <td>${order.user ? order.user.firstName + ' ' + order.user.lastName : ''}</td>
                        <td>${order.total} ‚ÇΩ</td>
                        <td><span class="status-badge ${statusClass}">${order.status}</span></td>
                        <td>${new Date(order.createdAt).toLocaleDateString('ru-RU')}</td>
                        <td>
                            <button class="btn-admin" style="padding: 5px 10px; font-size: 0.9rem;" onclick="openOrderModal(${order.orderId})">–ü—Ä–æ—Å–º–æ—Ç—Ä</button>
                        </td>
                    </tr>
                `;
            });
            ordersTableBody.innerHTML = html;
        })
        .catch(error => {
            console.error('Error loading orders:', error);
            document.getElementById('ordersTableBody').innerHTML = '<tr><td colspan="6" style="text-align: center;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</td></tr>';
        });
    }
    
    // --- –û—Ç–∑—ã–≤—ã (–º–æ–¥–µ—Ä–∞—Ü–∏—è) ---
    function loadReviewsData() {
        fetch('/api/admin/reviews/', {
            headers: { 'Authorization': `Token ${authToken}` }
        })
        .then(r => r.json())
        .then(data => {
            const tbody = document.getElementById('reviewsTableBody');
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">–ù–µ—Ç –æ—Ç–∑—ã–≤–æ–≤</td></tr>';
                return;
            }
            const userDisplay = (u) => u ? `${u.firstName || ''} ${u.lastName || ''}`.trim() || u.email || '‚Äî' : '‚Äî';
            const trunc = (s, len) => {
                if (s == null || s === '') return '‚Äî';
                const str = String(s);
                return str.length > (len || 80) ? str.slice(0, len) + '‚Ä¶' : str;
            };
            tbody.innerHTML = data.map(review => `
                <tr>
                    <td>${review.reviewId}</td>
                    <td>${escapeHtml(review.productName || '‚Äî')}</td>
                    <td>${escapeHtml(userDisplay(review.user))}</td>
                    <td>${review.rating != null ? review.rating : '‚Äî'}</td>
                    <td style="max-width: 200px;" title="${escapeHtml(review.reviewText || '')}">${escapeHtml(trunc(review.reviewText, 60))}</td>
                    <td>${review.createdAt ? new Date(review.createdAt).toLocaleString('ru-RU') : '‚Äî'}</td>
                    <td>
                        <button class="btn-admin" style="padding: 5px 10px; font-size: 0.9rem; background: #ef4444;" onclick="deleteReview(${review.reviewId})">–£–¥–∞–ª–∏—Ç—å</button>
                    </td>
                </tr>
            `).join('');
        })
        .catch(() => {
            document.getElementById('reviewsTableBody').innerHTML = '<tr><td colspan="7" style="text-align: center;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
        });
    }
    
    function deleteReview(reviewId) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –æ—Ç–∑—ã–≤?')) return;
        fetch(`/api/admin/reviews/${reviewId}/`, {
            method: 'DELETE',
            headers: { 'Authorization': `Token ${authToken}` }
        })
        .then(r => {
            if (!r.ok && r.status !== 204) throw new Error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
            return r.status === 204 ? {} : r.json();
        })
        .then(() => { alert('–û—Ç–∑—ã–≤ —É–¥–∞–ª—ë–Ω'); loadReviewsData(); })
        .catch(() => { alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞'); loadReviewsData(); });
    }
    
    // --- –ó–∞–∫–∞–∑: –ø—Ä–æ—Å–º–æ—Ç—Ä –∏ —Å–º–µ–Ω–∞ —Å—Ç–∞—Ç—É—Å–∞ ---
    var currentOrderData = null;
    function openOrderModal(orderId) {
        document.getElementById('orderModalOrderPk').value = orderId;
        document.getElementById('orderModalOrderId').textContent = '#' + orderId;
        fetch(`/api/admin/orders/${orderId}/`, {
            headers: { 'Authorization': `Token ${authToken}` }
        })
        .then(r => {
            if (!r.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–∞');
            return r.json();
        })
        .then(order => {
            currentOrderData = order;
            const user = order.user;
            document.getElementById('orderModalUser').textContent = user ? `${user.firstName || ''} ${user.lastName || ''} (${user.email || ''})` : '‚Äî';
            const addr = order.address;
            document.getElementById('orderModalAddress').textContent = addr ? `${addr.city || ''}, ${addr.street || ''}, ${addr.house || ''}${addr.flat ? ', –∫–≤. ' + addr.flat : ''}, ${addr.index || ''}` : '‚Äî';
            document.getElementById('orderModalDeliveryPayment').textContent = `${order.deliveryType || '‚Äî'} / ${order.paymentType || '‚Äî'} (${order.paymentStatus || '‚Äî'})`;
            const items = order.items || [];
            const itemsHtml = items.length ? items.map(it => {
                const qty = Number(it.quantity) || 1;
                const price = Number(it.unitPrice) || 0;
                const sum = (qty * price).toFixed(2);
                return `<div class="order-item-card"><div class="order-item-name">${escapeHtml(it.productName || '')}</div><div class="order-item-meta">√ó ${qty} ¬∑ ${price.toFixed(2)} ‚ÇΩ</div><div class="order-item-sum">${Number(sum).toLocaleString('ru-RU')} ‚ÇΩ</div></div>`;
            }).join('') : '<p style="color:#6c757d;margin:0;">–ù–µ—Ç –ø–æ–∑–∏—Ü–∏–π</p>';
            document.getElementById('orderModalItems').innerHTML = itemsHtml;
            document.getElementById('orderModalTotal').textContent = `${Number(order.total || 0).toLocaleString('ru-RU')} ‚ÇΩ`;
            if (order.note) {
                document.getElementById('orderModalNoteBlock').style.display = 'block';
                document.getElementById('orderModalNote').textContent = order.note;
            } else {
                document.getElementById('orderModalNoteBlock').style.display = 'none';
            }
            var btnMarkPaid = document.getElementById('btnMarkPaid');
            if ((order.paymentType === '–∫–∞—Ä—Ç–æ–π –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏' || order.paymentType === '–Ω–∞–ª–∏—á–Ω—ã–º–∏ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏') && order.paymentStatus !== '–æ–ø–ª–∞—á–µ–Ω–æ') {
                btnMarkPaid.style.display = 'inline-block';
            } else {
                btnMarkPaid.style.display = 'none';
            }
            return loadOrderStatuses().then(() => {
                const sel = document.getElementById('orderModalStatus');
                sel.value = order.orderStatusId != null ? order.orderStatusId : '';
            });
        })
        .then(() => { document.getElementById('orderModal').style.display = 'block'; })
        .catch(err => { console.error(err); alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–∞'); });
    }
    
    function markOrderAsPaid() {
        const orderId = document.getElementById('orderModalOrderPk').value;
        if (!orderId) return;
        if (!confirm('–û—Ç–º–µ—Ç–∏—Ç—å –∑–∞–∫–∞–∑ ‚Ññ' + orderId + ' –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–π?')) return;
        fetch(`/api/admin/orders/${orderId}/mark-paid/`, {
            method: 'POST',
            headers: { 'Authorization': `Token ${authToken}` }
        })
        .then(r => {
            if (!r.ok) return r.json().then(body => { throw new Error(body.detail || '–û—à–∏–±–∫–∞'); });
            return r.json();
        })
        .then(() => {
            alert('–ó–∞–∫–∞–∑ –æ—Ç–º–µ—á–µ–Ω –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–π');
            openOrderModal(orderId);
            loadOrdersData();
        })
        .catch(err => {
            alert(err.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ –∑–∞–∫–∞–∑–∞ –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω–æ–≥–æ');
        });
    }
    
    function loadOrderStatuses() {
        return fetch('/api/admin/order-statuses/', { headers: { 'Authorization': `Token ${authToken}` } })
            .then(r => r.json())
            .then(statuses => {
                const sel = document.getElementById('orderModalStatus');
                sel.innerHTML = statuses.map(s => `<option value="${s.orderStatusId}">${escapeHtml(s.orderStatusName)}</option>`).join('');
            })
            .catch(() => { document.getElementById('orderModalStatus').innerHTML = '<option value="">‚Äî</option>'; });
    }
    
    function closeOrderModal() {
        document.getElementById('orderModal').style.display = 'none';
    }
    
    function saveOrderStatus() {
        const orderId = document.getElementById('orderModalOrderPk').value;
        const orderStatusId = parseInt(document.getElementById('orderModalStatus').value, 10);
        if (!orderId || isNaN(orderStatusId)) { alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å'); return; }
        fetch(`/api/admin/orders/${orderId}/`, {
            method: 'PATCH',
            headers: { 'Authorization': `Token ${authToken}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ orderStatusId: orderStatusId })
        })
        .then(r => {
            if (!r.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
            return r.json();
        })
        .then(() => { alert('–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –æ–±–Ω–æ–≤–ª—ë–Ω'); closeOrderModal(); loadOrdersData(); })
        .catch(err => { console.error(err); alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞'); });
    }
    
    // --- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∂—É—Ä–Ω–∞–ª–æ–≤ (auditLog) ---
    let auditLogsCache = [];
    
    function loadAuditLogsData() {
        fetch('/api/admin/audit-logs/', {
            headers: { 'Authorization': `Token ${authToken}` }
        })
        .then(r => r.json())
        .then(data => {
            auditLogsCache = data || [];
            const tbody = document.getElementById('auditLogsTableBody');
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</td></tr>';
                return;
            }
            const actionLabels = { 'CREATE': '–°–æ–∑–¥–∞–Ω–∏–µ', 'UPDATE': '–ò–∑–º–µ–Ω–µ–Ω–∏–µ', 'DELETE': '–£–¥–∞–ª–µ–Ω–∏–µ' };
            const actionColors = { 'CREATE': '#10b981', 'UPDATE': '#f59e0b', 'DELETE': '#ef4444' };
            tbody.innerHTML = data.map((log, idx) => {
                const action = log.action || '‚Äî';
                const color = actionColors[action] || '#6b7280';
                const label = actionLabels[action] || action;
                return `
                <tr>
                    <td>${log.auditLogId}</td>
                    <td>${log.createdAt ? new Date(log.createdAt).toLocaleString('ru-RU') : '‚Äî'}</td>
                    <td>${escapeHtml(log.userDisplay || log.userId || '‚Äî')}</td>
                    <td><span style="color: ${color}; font-weight: 600;">${escapeHtml(label)}</span></td>
                    <td>${escapeHtml(log.tableName || '‚Äî')}</td>
                    <td>${log.recordId != null ? log.recordId : '‚Äî'}</td>
                    <td><button class="btn-admin" style="padding: 4px 12px; font-size: 0.85rem;" onclick="openAuditLogModal(${idx})">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button></td>
                </tr>
                `;
            }).join('');
        })
        .catch(() => {
            document.getElementById('auditLogsTableBody').innerHTML = '<tr><td colspan="7" style="text-align: center;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
        });
    }
    
    function formatJsonPretty(val) {
        if (val == null) return '‚Äî';
        try {
            const obj = typeof val === 'string' ? JSON.parse(val) : val;
            return JSON.stringify(obj, null, 2);
        } catch (e) {
            return String(val);
        }
    }
    
    function openAuditLogModal(idx) {
        const log = auditLogsCache[idx];
        if (!log) return;
        document.getElementById('auditDetailId').textContent = log.auditLogId;
        document.getElementById('auditDetailDate').textContent = log.createdAt ? new Date(log.createdAt).toLocaleString('ru-RU') : '‚Äî';
        document.getElementById('auditDetailUser').textContent = log.userDisplay || log.userId || '‚Äî';
        document.getElementById('auditDetailAction').textContent = log.action || '‚Äî';
        document.getElementById('auditDetailTable').textContent = log.tableName || '‚Äî';
        document.getElementById('auditDetailRecordId').textContent = log.recordId != null ? log.recordId : '‚Äî';
        document.getElementById('auditDetailOld').textContent = formatJsonPretty(log.oldValues);
        document.getElementById('auditDetailNew').textContent = formatJsonPretty(log.newValues);
        document.getElementById('auditLogModal').style.display = 'block';
    }
    
    function closeAuditLogModal() {
        document.getElementById('auditLogModal').style.display = 'none';
    }
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Ä–∞–∑–¥–µ–ª–∞–º–∏ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
    function showAdminSection(sectionId) {
        // –°–∫—Ä—ã—Ç—å –≤—Å–µ —Å–µ–∫—Ü–∏–∏
        document.querySelectorAll('.admin-section').forEach(section => {
            section.classList.remove('active');
        });
        
        // –£–±—Ä–∞—Ç—å –∫–ª–∞—Å—Å active —É –≤—Å–µ—Ö —Å—Å—ã–ª–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        document.querySelectorAll('.admin-nav a').forEach(link => {
            link.classList.remove('active');
        });
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å–µ–∫—Ü–∏—é
        document.getElementById(`${sectionId}-section`).classList.add('active');
        
        // –û—Ç–º–µ—Ç–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω—É—é
        event.currentTarget.classList.add('active');
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–∞–∑–¥–µ–ª–∞
        if (sectionId === 'dashboard') {
            loadDashboardStats();
        } else if (sectionId === 'products') {
            loadProductsData();
        } else if (sectionId === 'categories') {
            loadCategoriesData();
        } else if (sectionId === 'brands') {
            loadBrandsData();
        } else if (sectionId === 'users') {
            loadUsersData();
        } else if (sectionId === 'orders') {
            loadOrdersData();
        } else if (sectionId === 'reviews') {
            loadReviewsData();
        } else if (sectionId === 'logs') {
            loadAuditLogsData();
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –≤—ã—Ö–æ–¥–∞
    function logout() {
        localStorage.removeItem('authToken');
        window.location.href = '/';
    }
    
    // –§—É–Ω–∫—Ü–∏–∏ CRUD —Ç–æ–≤–∞—Ä–æ–≤
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏ –±—Ä–µ–Ω–¥–æ–≤ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤
    function loadCategoriesAndBrands() {
        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        fetch('/api/catalog/categories/')
            .then(response => response.json())
            .then(categories => {
                const categorySelect = document.getElementById('categoryId');
                categorySelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.categoryId;
                    option.textContent = category.categoryName;
                    categorySelect.appendChild(option);
                });
            })
            .catch(error => console.error('Error loading categories:', error));
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –±—Ä–µ–Ω–¥–æ–≤
        fetch('/api/catalog/brands/')
            .then(response => response.json())
            .then(brands => {
                const brandSelect = document.getElementById('brandId');
                brandSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–µ–Ω–¥</option>';
                brands.forEach(brand => {
                    const option = document.createElement('option');
                    option.value = brand.brandId;
                    option.textContent = brand.brandName;
                    brandSelect.appendChild(option);
                });
            })
            .catch(error => console.error('Error loading brands:', error));
    }
    
    // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ç–æ–≤–∞—Ä–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è
    function openProductModal(productId = null) {
        loadCategoriesAndBrands();
        clearAttributes(); // –û—á–∏—Å—Ç–∏—Ç—å –∞—Ç—Ä–∏–±—É—Ç—ã –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        
        const modal = document.getElementById('productModal');
        const form = document.getElementById('productForm');
        const title = document.getElementById('modalTitle');
        
        if (productId) {
            // –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            title.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–¥—É–∫—Ç';
            document.getElementById('productId').value = productId;
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–∞
            fetch(`/api/admin/products/${productId}/`, {
                headers: {
                    'Authorization': `Token ${authToken}`
                }
            })
            .then(response => response.json())
            .then(product => {
                console.log('=== FULL PRODUCT DATA ===');
                console.log('Raw product data:', JSON.stringify(product, null, 2));
                console.log('Product ID:', product.productId);
                console.log('Product Name:', product.productName);
                console.log('Category ID:', product.categoryId);
                console.log('Brand ID:', product.brandId);
                console.log('Category object:', product.category);
                console.log('Brand object:', product.brand);
                console.log('Attributes:', product.attributes);
                console.log('Images:', product.images);
                console.log('=========================');
                
                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤
                setTimeout(() => {
                    // –ó–∞–ø–æ–ª–Ω–∏—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è
                    document.getElementById('productName').value = product.productName;
                    document.getElementById('productDescription').value = product.productDescription || '';
                    
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Äî –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø—Ä—è–º–æ–π ID –∏ –≤–ª–æ–∂–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç
                    const categoryId = product.categoryId || (product.category ? product.category.categoryId : null);
                    if (categoryId) {
                        document.getElementById('categoryId').value = categoryId;
                        console.log('Set category ID to:', categoryId);
                    }
                    
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –±—Ä–µ–Ω–¥–∞ ‚Äî –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø—Ä—è–º–æ–π ID –∏ –≤–ª–æ–∂–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç
                    const brandId = product.brandId || (product.brand ? product.brand.brandId : null);
                    if (brandId) {
                        document.getElementById('brandId').value = brandId;
                        console.log('Set brand ID to:', brandId);
                    }
                    
                    document.getElementById('price').value = product.price;
                    document.getElementById('quantity').value = product.quantity;
                    document.getElementById('ageRating').value = product.ageRating;
                    document.getElementById('weightKg').value = product.weightKg || '';
                    document.getElementById('dimensions').value = product.dimensions || '';
                    
                    // –û—Ç–ª–∞–¥–æ—á–Ω—ã–µ —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                    console.log('Final category dropdown value:', document.getElementById('categoryId').value);
                    console.log('Final brand dropdown value:', document.getElementById('brandId').value);
                    
                    // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∞—Ç—Ä–∏–±—É—Ç—ã —Ç–æ–≤–∞—Ä–∞, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                    const attributes = product.attributes;
                    if (attributes && attributes.length > 0) {
                        console.log('Found attributes to load:', attributes);
                        loadProductAttributes(attributes);
                    } else {
                        console.log('No attributes found');
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–∞
                    const images = product.images;
                    if (images && images.length > 0) {
                        document.getElementById('existingImagesBlock').style.display = 'block';
                        const listEl = document.getElementById('existingImagesList');
                        listEl.innerHTML = images.map(img => {
                            const mainBadge = img.isMain ? '<span class="img-main-badge">–ì–ª–∞–≤–Ω–æ–µ</span>' : '';
                            return `<div class="img-item"><img src="${img.url}" alt="${img.altText || ''}">${mainBadge}</div>`;
                        }).join('');
                    } else {
                        document.getElementById('existingImagesBlock').style.display = 'none';
                        document.getElementById('existingImagesList').innerHTML = '';
                    }
                }, 100); // –ó–∞–¥–µ—Ä–∂–∫–∞ 100 –º—Å
            })
            .catch(error => {
                console.error('Error loading product:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–∞');
            });
        } else {
            // –†–µ–∂–∏–º —Å–æ–∑–¥–∞–Ω–∏—è
            title.textContent = '–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç';
            document.getElementById('productId').value = '';
            form.reset();
            document.getElementById('existingImagesBlock').style.display = 'none';
            document.getElementById('existingImagesList').innerHTML = '';
            document.getElementById('ageRating').value = '';
        }
        
        modal.style.display = 'block';
    }
    
    // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ç–æ–≤–∞—Ä–∞
    function closeProductModal() {
        document.getElementById('productModal').style.display = 'none';
        document.getElementById('productForm').reset();
        document.getElementById('productId').value = '';
        document.getElementById('productImages').value = '';
        clearAttributes();
        // –°–±—Ä–æ—Å–∏—Ç—å –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –≤–æ–∑—Ä–∞—Å—Ç–∞
        document.getElementById('ageRating').value = '';
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    document.getElementById('productForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const productId = document.getElementById('productId').value;
        const formData = {
            productName: document.getElementById('productName').value,
            productDescription: document.getElementById('productDescription').value,
            categoryId: parseInt(document.getElementById('categoryId').value),
            brandId: parseInt(document.getElementById('brandId').value),
            price: parseFloat(document.getElementById('price').value),
            quantity: parseInt(document.getElementById('quantity').value),
            ageRating: parseInt(document.getElementById('ageRating').value),
            weightKg: parseFloat(document.getElementById('weightKg').value) || 0,
            dimensions: document.getElementById('dimensions').value
        };
        
        // –ü–æ–ª—É—á–∏—Ç—å –∞—Ç—Ä–∏–±—É—Ç—ã —Ç–æ–≤–∞—Ä–∞
        const attributes = getProductAttributes();
        
        let url, method;
        
        if (productId) {
            // –û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ç–æ–≤–∞—Ä
            url = `/api/admin/products/${productId}/`;
            method = 'PUT';
        } else {
            // –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ç–æ–≤–∞—Ä
            url = '/api/admin/products/create/';
            method = 'POST';
        }
        
        // –°–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä–∞
        fetch(url, {
            method: method,
            headers: {
                'Authorization': `Token ${authToken}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(async (data) => {
            const savedProductId = data.productId ?? data.id ?? productId;
            if (!savedProductId) {
                alert('–û—à–∏–±–∫–∞: –Ω–µ –ø–æ–ª—É—á–µ–Ω ID –ø—Ä–æ–¥—É–∫—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
                return;
            }
            
            try {
                if (attributes.length > 0) {
                    await saveProductAttributes(savedProductId, attributes);
                }
                const imageFiles = document.getElementById('productImages').files;
                if (imageFiles.length > 0) {
                    await saveProductImages(savedProductId, imageFiles);
                }
                alert(productId ? '–ü—Ä–æ–¥—É–∫—Ç —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!' : '–ü—Ä–æ–¥—É–∫—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!');
                closeProductModal();
                loadProductsData();
            } catch (err) {
                console.error('Error saving attributes/images:', err);
                alert('–ü—Ä–æ–¥—É–∫—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω, –Ω–æ –≤–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ñ–æ—Ç–æ –∏–ª–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫: ' + (err.message || err));
            }
        })
        .catch(error => {
            console.error('Error saving product:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–∞');
        });
    });
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ URL
    async function uploadProductImageFile(file) {
        const formData = new FormData();
        formData.append('file', file);
        const response = await fetch('/api/admin/upload-image/', {
            method: 'POST',
            headers: {
                'Authorization': `Token ${authToken}`
            },
            body: formData
        });
        if (!response.ok) {
            const err = await response.json().catch(() => ({}));
            throw new Error(err.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
        }
        const data = await response.json();
        return data.url;
    }
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –ø—Ä–æ–¥—É–∫—Ç–∞: –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –∏ –ø—Ä–∏–≤—è–∑–∫–∞ –∫ –ø—Ä–æ–¥—É–∫—Ç—É
    async function saveProductImages(productId, imageFiles) {
        for (let i = 0; i < imageFiles.length; i++) {
            const file = imageFiles[i];
            const url = await uploadProductImageFile(file);
            const altText = file.name || `–§–æ—Ç–æ ${i + 1}`;
            const isMain = i === 0;
            const resp = await fetch(`/api/admin/products/${productId}/images/`, {
                method: 'POST',
                headers: {
                    'Authorization': `Token ${authToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url: url, altText: altText, isMain: isMain })
            });
            if (!resp.ok) {
                const errData = await resp.json().catch(() => ({}));
                throw new Error(errData.detail || errData.url || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–æ—Ç–æ ' + resp.status);
            }
        }
    }
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞—Ç—Ä–∏–±—É—Ç–æ–≤ —Ç–æ–≤–∞—Ä–∞
    async function saveProductAttributes(productId, attributes) {
        const existingAttributesResponse = await fetch(`/api/admin/products/${productId}/attributes/`, {
            headers: { 'Authorization': `Token ${authToken}` }
        });
        if (existingAttributesResponse.ok) {
            const existingAttributes = await existingAttributesResponse.json();
            for (const attr of existingAttributes) {
                const delResp = await fetch(`/api/admin/products/${productId}/attributes/${attr.productAttributeId}/`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Token ${authToken}` }
                });
                if (!delResp.ok && delResp.status !== 204) {
                    throw new Error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫');
                }
            }
        }
        for (const attr of attributes) {
            const resp = await fetch(`/api/admin/products/${productId}/attributes/`, {
                method: 'POST',
                headers: {
                    'Authorization': `Token ${authToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    productAttributeName: attr.productAttributeName,
                    productAttributeValue: attr.productAttributeValue,
                    productAttributeUnit: attr.productAttributeUnit || null
                })
            });
            if (!resp.ok) {
                const errData = await resp.json().catch(() => ({}));
                throw new Error(errData.detail || JSON.stringify(errData) || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ ' + resp.status);
            }
        }
    }
    
    // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏ –∫–ª–∏–∫–µ —Å–Ω–∞—Ä—É–∂–∏
    window.onclick = function(event) {
        const modal = document.getElementById('productModal');
        if (event.target == modal) {
            closeProductModal();
        }
    };
    
    // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏ –∞—Ç—Ä–∏–±—É—Ç–∞
    function addAttributeRow() {
        const container = document.getElementById('attributesContainer');
        const row = document.createElement('div');
        row.className = 'attribute-row form-row';
        row.style.marginBottom = '10px';
        row.innerHTML = `
            <div class="form-group">
                <input type="text" class="form-control attribute-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏">
            </div>
            <div class="form-group">
                <input type="text" class="form-control attribute-value" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ">
            </div>
            <div class="form-group">
                <input type="text" class="form-control attribute-unit" placeholder="–ï–¥. –∏–∑–º–µ—Ä–µ–Ω–∏—è (–æ–ø—Ü.)">
            </div>
            <div class="form-group">
                <button type="button" class="btn-admin" style="padding: 5px 10px; background: #dc3545;" onclick="removeAttributeRow(this)">-</button>
            </div>
        `;
        container.appendChild(row);
    }
    
    // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏ –∞—Ç—Ä–∏–±—É—Ç–∞
    function removeAttributeRow(button) {
        const row = button.closest('.attribute-row');
        row.remove();
    }
    
    // –ü–æ–ª—É—á–∏—Ç—å –∞—Ç—Ä–∏–±—É—Ç—ã –∏–∑ —Ñ–æ—Ä–º—ã
    function getProductAttributes() {
        const attributeRows = document.querySelectorAll('.attribute-row');
        const attributes = [];
        
        attributeRows.forEach(row => {
            const nameInput = row.querySelector('.attribute-name');
            const valueInput = row.querySelector('.attribute-value');
            const unitInput = row.querySelector('.attribute-unit');
            
            if (nameInput.value.trim() && valueInput.value.trim()) {
                attributes.push({
                    productAttributeName: nameInput.value.trim(),
                    productAttributeValue: valueInput.value.trim(),
                    productAttributeUnit: unitInput.value.trim() || null
                });
            }
        });
        
        return attributes;
    }
    
    // –û—á–∏—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∞—Ç—Ä–∏–±—É—Ç–æ–≤, –∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏
    function clearAttributes() {
        const container = document.getElementById('attributesContainer');
        const rows = container.querySelectorAll('.attribute-row');
        // –û—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É
        for (let i = 1; i < rows.length; i++) {
            rows[i].remove();
        }
        // –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª—è –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏
        const firstRow = rows[0];
        firstRow.querySelector('.attribute-name').value = '';
        firstRow.querySelector('.attribute-value').value = '';
        firstRow.querySelector('.attribute-unit').value = '';
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ç—Ä–∏–±—É—Ç–æ–≤ —Ç–æ–≤–∞—Ä–∞ –≤ —Ñ–æ—Ä–º—É
    function loadProductAttributes(attributes) {
        console.log('Loading attributes:', attributes);
        const container = document.getElementById('attributesContainer');
        
        // –û—á–∏—Å—Ç–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∞—Ç—Ä–∏–±—É—Ç—ã, –∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–π –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–∏
        clearAttributes();
        
        // –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞—Ç—Ä–∏–±—É—Ç–∞
        if (attributes && attributes.length > 0) {
            attributes.forEach((attr, index) => {
                console.log(`Processing attribute ${index}:`, attr);
                if (index === 0) {
                    // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É
                    const firstRow = container.querySelector('.attribute-row');
                    if (firstRow) {
                        const nameInput = firstRow.querySelector('.attribute-name');
                        const valueInput = firstRow.querySelector('.attribute-value');
                        const unitInput = firstRow.querySelector('.attribute-unit');
                        
                        if (nameInput && valueInput) {
                            nameInput.value = attr.productAttributeName || attr.name || '';
                            valueInput.value = attr.productAttributeValue || attr.value || '';
                            if (unitInput) {
                                unitInput.value = attr.productAttributeUnit || attr.unit || '';
                            }
                            console.log(`Set first row: ${nameInput.value} = ${valueInput.value}`);
                        }
                    }
                } else {
                    // –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏
                    addAttributeRow();
                    const rows = container.querySelectorAll('.attribute-row');
                    const newRow = rows[rows.length - 1];
                    if (newRow) {
                        const nameInput = newRow.querySelector('.attribute-name');
                        const valueInput = newRow.querySelector('.attribute-value');
                        const unitInput = newRow.querySelector('.attribute-unit');
                        
                        if (nameInput && valueInput) {
                            nameInput.value = attr.productAttributeName || attr.name || '';
                            valueInput.value = attr.productAttributeValue || attr.value || '';
                            if (unitInput) {
                                unitInput.value = attr.productAttributeUnit || attr.unit || '';
                            }
                            console.log(`Set row ${index}: ${nameInput.value} = ${valueInput.value}`);
                        }
                    }
                }
            });
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞
    function deleteProduct(productId) {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø—Ä–æ–¥—É–∫—Ç?')) {
            fetch(`/api/admin/products/${productId}/`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Token ${authToken}`
                }
            })
            .then(response => {
                console.log('Delete response status:', response.status);
                if (!response.ok) {
                    // –î–ª—è DELETE-–∑–∞–ø—Ä–æ—Å–æ–≤ 204 No Content –æ–∑–Ω–∞—á–∞–µ—Ç —É—Å–ø–µ—Ö
                    if (response.status !== 204) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                }
                // –ù–µ –ø—ã—Ç–∞—Ç—å—Å—è –ø–∞—Ä—Å–∏—Ç—å JSON –¥–ª—è –æ—Ç–≤–µ—Ç–∞ 204
                if (response.status === 204) {
                    return { success: true };
                }
                return response.json();
            })
            .then(data => {
                console.log('Delete successful:', data);
                alert('–ü—Ä–æ–¥—É–∫—Ç —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!');
                loadProductsData();
            })
            .catch(error => {
                console.error('Error deleting product:', error);
                // –í—Å—ë —Ä–∞–≤–Ω–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–ª—É—á–∞–π —É—Å–ø–µ—à–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
                loadProductsData();
                alert('–ü—Ä–æ–¥—É–∫—Ç –±—ã–ª —É–¥–∞–ª–µ–Ω (–≤–æ–∑–º–æ–∂–Ω–æ –±—ã–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏)');
            });
        }
    }
    
    // --- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ ---
    function loadCategoriesData() {
        fetch('/api/admin/categories/', {
            headers: { 'Authorization': `Token ${authToken}` }
        })
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('categoriesTableBody');
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">–ù–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π</td></tr>';
                return;
            }
            tbody.innerHTML = data.map(c => `
                <tr>
                    <td>${c.categoryId}</td>
                    <td>${escapeHtml(c.categoryName)}</td>
                    <td>${escapeHtml((c.categoryDescription || '').slice(0, 80))}${(c.categoryDescription || '').length > 80 ? '‚Ä¶' : ''}</td>
                    <td>
                        <button class="btn-admin" style="padding: 5px 10px; font-size: 0.9rem; margin-right: 5px;" onclick="openCategoryModal(${c.categoryId})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button class="btn-admin" style="padding: 5px 10px; font-size: 0.9rem; background: #ef4444;" onclick="deleteCategory(${c.categoryId})">–£–¥–∞–ª–∏—Ç—å</button>
                    </td>
                </tr>
            `).join('');
        })
        .catch(() => {
            document.getElementById('categoriesTableBody').innerHTML = '<tr><td colspan="4" style="text-align: center;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
        });
    }
    
    function openCategoryModal(categoryId = null) {
        const modal = document.getElementById('categoryModal');
        const title = document.getElementById('categoryModalTitle');
        if (categoryId) {
            title.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é';
            document.getElementById('editCategoryId').value = categoryId;
            fetch(`/api/admin/categories/${categoryId}/`, { headers: { 'Authorization': `Token ${authToken}` } })
                .then(r => r.json())
                .then(c => {
                    document.getElementById('categoryName').value = c.categoryName;
                    document.getElementById('categoryDescription').value = c.categoryDescription || '';
                })
                .catch(() => alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'));
        } else {
            title.textContent = '–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é';
            document.getElementById('editCategoryId').value = '';
            document.getElementById('categoryForm').reset();
        }
        modal.style.display = 'block';
    }
    
    function closeCategoryModal() {
        document.getElementById('categoryModal').style.display = 'none';
        document.getElementById('categoryForm').reset();
        document.getElementById('editCategoryId').value = '';
    }
    
    document.getElementById('categoryForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const id = document.getElementById('editCategoryId').value;
        const payload = {
            categoryName: document.getElementById('categoryName').value,
            categoryDescription: document.getElementById('categoryDescription').value
        };
        const url = id ? `/api/admin/categories/${id}/` : '/api/admin/categories/';
        const method = id ? 'PUT' : 'POST';
        fetch(url, {
            method,
            headers: { 'Authorization': `Token ${authToken}`, 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(r => { if (!r.ok) throw new Error(); return r.json(); })
        .then(() => { alert(id ? '–ö–∞—Ç–µ–≥–æ—Ä–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞!' : '–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∞!'); closeCategoryModal(); loadCategoriesData(); loadCategoriesAndBrandsForProduct(); })
        .catch(() => alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'));
    });
    
    function deleteCategory(categoryId) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∫–∞—Ç–µ–≥–æ—Ä–∏—é? –ü—Ä–æ–¥—É–∫—Ç—ã —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –º–æ–≥—É—Ç –ø–æ—Å—Ç—Ä–∞–¥–∞—Ç—å.')) return;
        fetch(`/api/admin/categories/${categoryId}/`, { method: 'DELETE', headers: { 'Authorization': `Token ${authToken}` } })
        .then(r => { if (!r.ok && r.status !== 204) throw new Error(); })
        .then(() => { alert('–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É–¥–∞–ª–µ–Ω–∞'); loadCategoriesData(); loadCategoriesAndBrandsForProduct(); })
        .catch(() => alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'));
    }
    
    // --- –ë—Ä–µ–Ω–¥—ã ---
    function loadBrandsData() {
        fetch('/api/admin/brands/', {
            headers: { 'Authorization': `Token ${authToken}` }
        })
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('brandsTableBody');
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">–ù–µ—Ç –±—Ä–µ–Ω–¥–æ–≤</td></tr>';
                return;
            }
            tbody.innerHTML = data.map(b => `
                <tr>
                    <td>${b.brandId}</td>
                    <td>${escapeHtml(b.brandName)}</td>
                    <td>${escapeHtml(b.brandCountry || '')}</td>
                    <td>${escapeHtml((b.brandDescription || '').slice(0, 60))}${(b.brandDescription || '').length > 60 ? '‚Ä¶' : ''}</td>
                    <td>
                        <button class="btn-admin" style="padding: 5px 10px; font-size: 0.9rem; margin-right: 5px;" onclick="openBrandModal(${b.brandId})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button class="btn-admin" style="padding: 5px 10px; font-size: 0.9rem; background: #ef4444;" onclick="deleteBrand(${b.brandId})">–£–¥–∞–ª–∏—Ç—å</button>
                    </td>
                </tr>
            `).join('');
        })
        .catch(() => {
            document.getElementById('brandsTableBody').innerHTML = '<tr><td colspan="5" style="text-align: center;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
        });
    }
    
    function openBrandModal(brandId = null) {
        const modal = document.getElementById('brandModal');
        const title = document.getElementById('brandModalTitle');
        if (brandId) {
            title.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –±—Ä–µ–Ω–¥';
            document.getElementById('editBrandId').value = brandId;
            fetch(`/api/admin/brands/${brandId}/`, { headers: { 'Authorization': `Token ${authToken}` } })
                .then(r => r.json())
                .then(b => {
                    document.getElementById('brandName').value = b.brandName;
                    document.getElementById('brandCountry').value = b.brandCountry || '';
                    document.getElementById('brandDescription').value = b.brandDescription || '';
                })
                .catch(() => alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±—Ä–µ–Ω–¥–∞'));
        } else {
            title.textContent = '–î–æ–±–∞–≤–∏—Ç—å –±—Ä–µ–Ω–¥';
            document.getElementById('editBrandId').value = '';
            document.getElementById('brandForm').reset();
        }
        modal.style.display = 'block';
    }
    
    function closeBrandModal() {
        document.getElementById('brandModal').style.display = 'none';
        document.getElementById('brandForm').reset();
        document.getElementById('editBrandId').value = '';
    }
    
    document.getElementById('brandForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const id = document.getElementById('editBrandId').value;
        const payload = {
            brandName: document.getElementById('brandName').value,
            brandCountry: document.getElementById('brandCountry').value,
            brandDescription: document.getElementById('brandDescription').value
        };
        const url = id ? `/api/admin/brands/${id}/` : '/api/admin/brands/';
        const method = id ? 'PUT' : 'POST';
        fetch(url, {
            method,
            headers: { 'Authorization': `Token ${authToken}`, 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(r => { if (!r.ok) throw new Error(); return r.json(); })
        .then(() => { alert(id ? '–ë—Ä–µ–Ω–¥ –æ–±–Ω–æ–≤–ª–µ–Ω!' : '–ë—Ä–µ–Ω–¥ —Å–æ–∑–¥–∞–Ω!'); closeBrandModal(); loadBrandsData(); loadCategoriesAndBrandsForProduct(); })
        .catch(() => alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –±—Ä–µ–Ω–¥–∞'));
    });
    
    function deleteBrand(brandId) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –±—Ä–µ–Ω–¥? –ü—Ä–æ–¥—É–∫—Ç—ã —ç—Ç–æ–≥–æ –±—Ä–µ–Ω–¥–∞ –º–æ–≥—É—Ç –ø–æ—Å—Ç—Ä–∞–¥–∞—Ç—å.')) return;
        fetch(`/api/admin/brands/${brandId}/`, { method: 'DELETE', headers: { 'Authorization': `Token ${authToken}` } })
        .then(r => { if (!r.ok && r.status !== 204) throw new Error(); })
        .then(() => { alert('–ë—Ä–µ–Ω–¥ —É–¥–∞–ª–µ–Ω'); loadBrandsData(); loadCategoriesAndBrandsForProduct(); })
        .catch(() => alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –±—Ä–µ–Ω–¥–∞'));
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // –û–±–Ω–æ–≤–∏—Ç—å –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π/–±—Ä–µ–Ω–¥–æ–≤ –≤ —Ñ–æ—Ä–º–µ –ø—Ä–æ–¥—É–∫—Ç–∞ (–ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Ä–∞–∑–¥–µ–ª–∞—Ö –ö–∞—Ç–µ–≥–æ—Ä–∏–∏/–ë—Ä–µ–Ω–¥—ã)
    function loadCategoriesAndBrandsForProduct() {
        loadCategoriesAndBrands();
    }
    
    // –§—É–Ω–∫—Ü–∏–∏ CRUD –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–æ–ª–µ–π –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
    function loadRoles() {
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–æ–ª–µ–π –∏–∑ API
        fetch('/api/admin/roles/', {
            headers: {
                'Authorization': `Token ${authToken}`
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to load roles');
            }
            return response.json();
        })
        .then(roles => {
            const roleSelect = document.getElementById('userRoleId');
            roleSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å</option>';
            
            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–æ–ª–∏ –ø–æ ID –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            roles.sort((a, b) => a.roleId - b.roleId);
            
            roles.forEach(role => {
                const option = document.createElement('option');
                option.value = role.roleId;
                option.textContent = role.roleName;
                roleSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading roles:', error);
            // –†–µ–∑–µ—Ä–≤–Ω—ã–µ —Ä–æ–ª–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–∏ —Å–±–æ–µ API
            const roleSelect = document.getElementById('userRoleId');
            roleSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å</option>';
            const defaultRoles = [
                { roleId: 1, roleName: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' },
                { roleId: 2, roleName: '–†–µ–±–µ–Ω–æ–∫' },
                { roleId: 4, roleName: '–ú–µ–Ω–µ–¥–∂–µ—Ä' },
                { roleId: 5, roleName: '–ü–æ–∫—É–ø–∞—Ç–µ–ª—å' }
            ];
            defaultRoles.forEach(role => {
                const option = document.createElement('option');
                option.value = role.roleId;
                option.textContent = role.roleName;
                roleSelect.appendChild(option);
            });
        });
    }
    
    // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    function openUserModal(userId = null) {
        loadRoles();
        
        const modal = document.getElementById('userModal');
        const form = document.getElementById('userForm');
        const title = document.getElementById('userModalTitle');
        
        if (userId) {
            // –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            title.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
            document.getElementById('userId').value = userId;
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            fetch(`/api/admin/users/${userId}/`, {
                headers: {
                    'Authorization': `Token ${authToken}`
                }
            })
            .then(response => response.json())
            .then(user => {
                document.getElementById('userFirstName').value = user.firstName;
                document.getElementById('userLastName').value = user.lastName;
                document.getElementById('userMiddleName').value = user.middleName || '';
                document.getElementById('userEmail').value = user.email;
                document.getElementById('userPhone').value = user.phone;
                document.getElementById('userBirthDate').value = user.birthDate;
                document.getElementById('userRoleId').value = user.roleId;
                // –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ –ø–∞—Ä–æ–ª—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                document.getElementById('userPassword').value = '';
            })
            .catch(error => {
                console.error('Error loading user:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            });
        } else {
            // –†–µ–∂–∏–º —Å–æ–∑–¥–∞–Ω–∏—è
            title.textContent = '–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
            document.getElementById('userId').value = '';
            form.reset();
        }
        
        modal.style.display = 'block';
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', function() {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∫–æ–¥–æ–º –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—ã—à–µ
    });
    
    // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function closeUserModal() {
        document.getElementById('userModal').style.display = 'none';
        document.getElementById('userForm').reset();
        document.getElementById('userId').value = '';
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    document.getElementById('userForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const userId = document.getElementById('userId').value;
        const formData = {
            firstName: document.getElementById('userFirstName').value,
            lastName: document.getElementById('userLastName').value,
            middleName: document.getElementById('userMiddleName').value || null,
            email: document.getElementById('userEmail').value,
            phone: document.getElementById('userPhone').value,
            birthDate: document.getElementById('userBirthDate').value,
            roleId: parseInt(document.getElementById('userRoleId').value),
            username: document.getElementById('userEmail').value // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å email –∫–∞–∫ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        };
        
        // –í–∫–ª—é—á–∞—Ç—å –ø–∞—Ä–æ–ª—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω –Ω–µ –ø—É—Å—Ç–æ–π
        const password = document.getElementById('userPassword').value;
        if (password) {
            formData.password = password;
        }
        
        let url, method;
        
        if (userId) {
            // –û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            url = `/api/admin/users/${userId}/`;
            method = 'PUT';
        } else {
            // –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            url = '/api/admin/users/create/';
            method = 'POST';
        }
        
        fetch(url, {
            method: method,
            headers: {
                'Authorization': `Token ${authToken}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(errData => {
                    const msg = errData.detail || (typeof errData === 'object' && Object.keys(errData).length ? JSON.stringify(errData) : '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                    throw new Error(msg);
                }).catch(e => { if (e.message) throw e; throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'); });
            }
            return response.json();
        })
        .then(data => {
            alert(userId ? '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!');
            closeUserModal();
            loadUsersData();
        })
        .catch(error => {
            console.error('Error saving user:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + (error.message || error));
        });
    });
    
    // –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (is_active = false)
    function blockUser(userId) {
        if (!confirm('–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è? –û–Ω –Ω–µ —Å–º–æ–∂–µ—Ç –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É.')) return;
        fetch(`/api/admin/users/${userId}/`, {
            method: 'PATCH',
            headers: {
                'Authorization': `Token ${authToken}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ is_active: false })
        })
        .then(r => {
            if (!r.ok) return r.json().then(d => { throw new Error(d.error || '–û—à–∏–±–∫–∞'); });
            return r.json();
        })
        .then(() => { alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'); loadUsersData(); })
        .catch(err => { alert(err.message || '–û—à–∏–±–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏'); loadUsersData(); });
    }
    
    // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (is_active = true)
    function unblockUser(userId) {
        fetch(`/api/admin/users/${userId}/`, {
            method: 'PATCH',
            headers: {
                'Authorization': `Token ${authToken}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ is_active: true })
        })
        .then(r => {
            if (!r.ok) return r.json().then(d => { throw new Error(d.error || '–û—à–∏–±–∫–∞'); });
            return r.json();
        })
        .then(() => { alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'); loadUsersData(); })
        .catch(err => { alert(err.message || '–û—à–∏–±–∫–∞'); loadUsersData(); });
    }
    
    // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏ –∫–ª–∏–∫–µ —Å–Ω–∞—Ä—É–∂–∏
    window.onclick = function(event) {
        const productModal = document.getElementById('productModal');
        const userModal = document.getElementById('userModal');
        const categoryModal = document.getElementById('categoryModal');
        const brandModal = document.getElementById('brandModal');
        const orderModal = document.getElementById('orderModal');
        if (event.target == productModal) closeProductModal();
        if (event.target == userModal) closeUserModal();
        if (event.target == categoryModal) closeCategoryModal();
        if (event.target == brandModal) closeBrandModal();
        if (event.target == orderModal) closeOrderModal();
        const auditLogModal = document.getElementById('auditLogModal');
        if (event.target == auditLogModal) closeAuditLogModal();
    };
    
    // =============================================
    // –†–ï–ó–ï–†–í–ù–û–ï –ö–û–ü–ò–†–û–í–ê–ù–ò–ï
    // =============================================
    
    function loadBackupsList() {
        fetch('/api/admin/backups/', {
            headers: { 'Authorization': `Token ${authToken}` }
        })
        .then(r => { if (!r.ok) throw new Error(); return r.json(); })
        .then(data => {
            const maxEl = document.getElementById('backupMaxCount');
            if (maxEl) maxEl.textContent = data.max_count || 10;
            
            const tbody = document.getElementById('backupsTableBody');
            if (!data.backups || data.backups.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">–ù–µ—Ç —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π</td></tr>';
                return;
            }
            tbody.innerHTML = data.backups.map(b => {
                const date = new Date(b.createdAt).toLocaleString('ru-RU');
                const fmtLabel = b.format === 'custom' ? 'Custom' : 'SQL';
                return `
                    <tr>
                        <td><code>${escapeHtml(b.filename)}</code></td>
                        <td>${fmtLabel}</td>
                        <td>${escapeHtml(b.sizeHuman)}</td>
                        <td>${date}</td>
                        <td>
                            <button class="btn-admin" style="padding: 4px 10px; font-size: 0.85rem; margin-right: 4px;" onclick="downloadBackup('${escapeHtml(b.filename)}')">–°–∫–∞—á–∞—Ç—å</button>
                            <button class="btn-admin" style="padding: 4px 10px; font-size: 0.85rem; margin-right: 4px; background: #f59e0b;" onclick="restoreBackup('${escapeHtml(b.filename)}')">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                            <button class="btn-admin" style="padding: 4px 10px; font-size: 0.85rem; background: #ef4444;" onclick="deleteBackup('${escapeHtml(b.filename)}')">–£–¥–∞–ª–∏—Ç—å</button>
                        </td>
                    </tr>
                `;
            }).join('');
        })
        .catch(() => {
            document.getElementById('backupsTableBody').innerHTML = '<tr><td colspan="5" style="text-align: center; color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
        });
    }
    
    function createBackup() {
        const btn = document.getElementById('createBackupBtn');
        const resultDiv = document.getElementById('backupCreateResult');
        const fmt = document.getElementById('backupFormat').value;
        const dataOnly = document.getElementById('backupDataOnly').checked;
        
        btn.disabled = true;
        btn.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ...';
        resultDiv.style.display = 'none';
        
        fetch('/api/admin/backups/', {
            method: 'POST',
            headers: {
                'Authorization': `Token ${authToken}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ format: fmt, dataOnly: dataOnly })
        })
        .then(r => r.json().then(body => ({ status: r.status, body })))
        .then(({ status, body }) => {
            resultDiv.style.display = 'block';
            if (status === 201) {
                resultDiv.style.background = '#d1fae5';
                resultDiv.style.border = '1px solid #10b981';
                resultDiv.innerHTML = `<strong>–£—Å–ø–µ—à–Ω–æ!</strong> ${escapeHtml(body.detail)}`;
                loadBackupsList();
            } else {
                resultDiv.style.background = '#fee2e2';
                resultDiv.style.border = '1px solid #ef4444';
                resultDiv.innerHTML = `<strong>–û—à–∏–±–∫–∞:</strong> ${escapeHtml(body.detail)}`;
            }
        })
        .catch(() => {
            resultDiv.style.display = 'block';
            resultDiv.style.background = '#fee2e2';
            resultDiv.style.border = '1px solid #ef4444';
            resultDiv.innerHTML = '<strong>–û—à–∏–±–∫–∞:</strong> –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø.';
        })
        .finally(() => {
            btn.disabled = false;
            btn.textContent = '–°–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø';
        });
    }
    
    function downloadBackup(filename) {
        window.open(`/api/admin/backups/download/${filename}/?token=${authToken}`, '_blank');
    }
    
    function restoreBackup(filename) {
        if (!confirm(`–í–ù–ò–ú–ê–ù–ò–ï! –í—Å–µ —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –≤ –±–∞–∑–µ –±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –±—ç–∫–∞–ø–∞ ¬´${filename}¬ª.\n\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`)) return;
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;
        
        fetch('/api/admin/backups/restore/', {
            method: 'POST',
            headers: {
                'Authorization': `Token ${authToken}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ filename: filename })
        })
        .then(r => r.json().then(body => ({ status: r.status, body })))
        .then(({ status, body }) => {
            if (status === 200) {
                alert('–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞! –°—Ç—Ä–∞–Ω–∏—Ü–∞ –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω–∞.');
                window.location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + (body.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å.'));
            }
        })
        .catch(() => alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏.'));
    }
    
    function deleteBackup(filename) {
        if (!confirm(`–£–¥–∞–ª–∏—Ç—å –±—ç–∫–∞–ø ¬´${filename}¬ª?`)) return;
        
        fetch(`/api/admin/backups/delete/${filename}/`, {
            method: 'DELETE',
            headers: { 'Authorization': `Token ${authToken}` }
        })
        .then(r => {
            if (r.ok) {
                loadBackupsList();
            } else {
                r.json().then(body => alert('–û—à–∏–±–∫–∞: ' + (body.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å.')));
            }
        })
        .catch(() => alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏.'));
    }
    
    // =============================================
    // –°–ò–°–¢–ï–ú–ê –ì–û–†–Ø–ß–ò–• –ö–õ–ê–í–ò–®
    // =============================================
    
    // –¢–µ–∫—É—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π —Ä–∞–∑–¥–µ–ª
    let currentSection = 'dashboard';
    
    // –ö–∞—Ä—Ç–∞ —Ä–∞–∑–¥–µ–ª–æ–≤ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    const sectionMap = {
        '1': 'dashboard',
        '2': 'products',
        '3': 'categories',
        '4': 'brands',
        '5': 'users',
        '6': 'orders',
        '7': 'reviews',
        '8': 'logs',
        '9': 'analytics',
        '0': 'backups'
    };
    
    // –§—É–Ω–∫—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞
    const refreshFunctions = {
        'dashboard': loadDashboardStats,
        'products': loadProductsData,
        'categories': loadCategoriesData,
        'brands': loadBrandsData,
        'users': loadUsersData,
        'orders': loadOrdersData,
        'reviews': loadReviewsData,
        'logs': loadAuditLogsData,
        'analytics': loadAnalyticsData,
        'data-io': function(){},
        'backups': loadBackupsList
    };
    
    // –§—É–Ω–∫—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞
    const createFunctions = {
        'products': () => openProductModal(),
        'categories': () => openCategoryModal(),
        'brands': () => openBrandModal(),
        'users': () => openUserModal()
    };
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ –ø–æ–º–æ—â–∏ –ø–æ –≥–æ—Ä—è—á–∏–º –∫–ª–∞–≤–∏—à–∞–º
    function toggleHotkeysHelp() {
        const helpPanel = document.getElementById('hotkeysHelp');
        const toggleBtn = document.querySelector('.hotkeys-toggle');
        helpPanel.classList.toggle('visible');
        toggleBtn.classList.toggle('hidden', helpPanel.classList.contains('visible'));
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞, –æ—Ç–∫—Ä—ã—Ç–æ –ª–∏ –∫–∞–∫–æ–µ-–ª–∏–±–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    function isAnyModalOpen() {
        const modals = document.querySelectorAll('.modal');
        for (const modal of modals) {
            if (modal.style.display === 'block') {
                return true;
            }
        }
        return false;
    }
    
    // –ü–æ–ª—É—á–∏—Ç—å –æ—Ç–∫—Ä—ã—Ç–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    function getOpenModal() {
        const modals = [
            { id: 'productModal', close: closeProductModal, form: 'productForm' },
            { id: 'userModal', close: closeUserModal, form: 'userForm' },
            { id: 'categoryModal', close: closeCategoryModal, form: 'categoryForm' },
            { id: 'brandModal', close: closeBrandModal, form: 'brandForm' },
            { id: 'orderModal', close: closeOrderModal, form: null }
        ];
        
        for (const modal of modals) {
            if (document.getElementById(modal.id).style.display === 'block') {
                return modal;
            }
        }
        return null;
    }
    
    // –ó–∞–∫—Ä—ã—Ç—å –≤—Å–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
    function closeAllModals() {
        const openModal = getOpenModal();
        if (openModal) {
            openModal.close();
            return true;
        }
        return false;
    }
    
    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ—Ä–º—É –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
    function saveCurrentForm() {
        const openModal = getOpenModal();
        if (openModal && openModal.form) {
            const form = document.getElementById(openModal.form);
            if (form) {
                // –°–æ–∑–¥–∞–µ–º –∏ –¥–∏—Å–ø–∞—Ç—á–∏–º —Å–æ–±—ã—Ç–∏–µ submit
                const submitEvent = new Event('submit', { cancelable: true, bubbles: true });
                form.dispatchEvent(submitEvent);
                return true;
            }
        }
        // –î–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∑–∞–∫–∞–∑–∞ - —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å
        if (openModal && openModal.id === 'orderModal') {
            saveOrderStatus();
            return true;
        }
        return false;
    }
    
    // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º —Å –ø–æ–º–æ—â—å—é –≥–æ—Ä—è—á–∏—Ö –∫–ª–∞–≤–∏—à
    function navigateToSection(sectionId) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ —Ä–∞–∑–¥–µ–ª (–¥–ª—è admin-only —Ä–∞–∑–¥–µ–ª–æ–≤)
        const navLink = document.querySelector(`.admin-nav a[data-section="${sectionId}"]`);
        if (!navLink || navLink.style.display === 'none') {
            return false;
        }
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –ø–µ—Ä–µ–¥ –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π
        closeAllModals();
        
        // –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –ø–æ–º–æ—â–∏
        const helpPanel = document.getElementById('hotkeysHelp');
        if (helpPanel.classList.contains('visible')) {
            toggleHotkeysHelp();
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —Ä–∞–∑–¥–µ–ª
        currentSection = sectionId;
        
        // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–µ–∫—Ü–∏–∏
        document.querySelectorAll('.admin-section').forEach(section => {
            section.classList.remove('active');
        });
        
        // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö —Å—Å—ã–ª–æ–∫
        document.querySelectorAll('.admin-nav a').forEach(link => {
            link.classList.remove('active');
        });
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å–µ–∫—Ü–∏—é
        const targetSection = document.getElementById(`${sectionId}-section`);
        if (targetSection) {
            targetSection.classList.add('active');
        }
        
        // –ü–æ–º–µ—á–∞–µ–º —Å—Å—ã–ª–∫—É –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω—É—é
        if (navLink) {
            navLink.classList.add('active');
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞
        if (refreshFunctions[sectionId]) {
            refreshFunctions[sectionId]();
        }
        
        return true;
    }
    
    // –û–±–Ω–æ–≤–∏—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é showAdminSection –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ —Ä–∞–∑–¥–µ–ª–∞
    const originalShowAdminSection = showAdminSection;
    showAdminSection = function(sectionId) {
        currentSection = sectionId;
        
        // –í–º–µ—Å—Ç–æ event.currentTarget –∏—Å–ø–æ–ª—å–∑—É–µ–º data-section –∞—Ç—Ä–∏–±—É—Ç
        document.querySelectorAll('.admin-section').forEach(section => {
            section.classList.remove('active');
        });
        
        document.querySelectorAll('.admin-nav a').forEach(link => {
            link.classList.remove('active');
        });
        
        document.getElementById(`${sectionId}-section`).classList.add('active');
        
        const navLink = document.querySelector(`.admin-nav a[data-section="${sectionId}"]`);
        if (navLink) {
            navLink.classList.add('active');
        }
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–∞–∑–¥–µ–ª–∞
        if (refreshFunctions[sectionId]) {
            refreshFunctions[sectionId]();
        }
    };
    
    // –ì–ª–∞–≤–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≥–æ—Ä—è—á–∏—Ö –∫–ª–∞–≤–∏—à
    document.addEventListener('keydown', function(e) {
        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º, –µ—Å–ª–∏ —Ñ–æ–∫—É—Å –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞ (–∫—Ä–æ–º–µ Escape)
        const activeElement = document.activeElement;
        const isInputFocused = activeElement && (
            activeElement.tagName === 'INPUT' ||
            activeElement.tagName === 'TEXTAREA' ||
            activeElement.tagName === 'SELECT' ||
            activeElement.isContentEditable
        );
        
        // Escape - –∑–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ (—Ä–∞–±–æ—Ç–∞–µ—Ç –≤—Å–µ–≥–¥–∞)
        if (e.key === 'Escape') {
            if (closeAllModals()) {
                e.preventDefault();
                return;
            }
            // –ó–∞–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å –ø–æ–º–æ—â–∏
            const helpPanel = document.getElementById('hotkeysHelp');
            if (helpPanel.classList.contains('visible')) {
                toggleHotkeysHelp();
                e.preventDefault();
                return;
            }
        }
        
        // Alt+–∫–æ–º–±–∏–Ω–∞—Ü–∏–∏
        if (e.altKey && !e.ctrlKey && !e.metaKey) {
            // Alt+H - –ø–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏
            if (e.key.toLowerCase() === 'h') {
                e.preventDefault();
                toggleHotkeysHelp();
                return;
            }
            
            // Alt+S - —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ—Ä–º—É (—Ä–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞)
            if (e.key.toLowerCase() === 's') {
                e.preventDefault();
                if (isAnyModalOpen()) {
                    saveCurrentForm();
                }
                return;
            }
            
            // –û—Å—Ç–∞–ª—å–Ω—ã–µ –≥–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
            if (isInputFocused) {
                return;
            }
            
            // Alt+1-8 - –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º
            if (sectionMap[e.key]) {
                e.preventDefault();
                navigateToSection(sectionMap[e.key]);
                return;
            }
            
            // Alt+N - —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç
            if (e.key.toLowerCase() === 'n') {
                e.preventDefault();
                if (!isAnyModalOpen() && createFunctions[currentSection]) {
                    createFunctions[currentSection]();
                }
                return;
            }
            
            // Alt+R - –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ —Ä–∞–∑–¥–µ–ª–∞
            if (e.key.toLowerCase() === 'r') {
                e.preventDefault();
                if (!isAnyModalOpen() && refreshFunctions[currentSection]) {
                    refreshFunctions[currentSection]();
                }
                return;
            }
        }
    });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –ø–æ—Å–µ—â–µ–Ω–∏–∏
    (function() {
        const hotkeysShown = localStorage.getItem('adminHotkeysShown');
        if (!hotkeysShown) {
            // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
            setTimeout(() => {
                toggleHotkeysHelp();
                localStorage.setItem('adminHotkeysShown', 'true');
            }, 2000);
        }
    })();
    
    // =============================================
    // –ê–ù–ê–õ–ò–¢–ò–ö–ê
    // =============================================
    
    // –≠–∫–∑–µ–º–ø–ª—è—Ä—ã –≥—Ä–∞—Ñ–∏–∫–æ–≤ (–¥–ª—è —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏—è –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏)
    let salesChart = null;
    let categoriesChart = null;
    let statusChart = null;
    let paymentChart = null;
    let topProductsChart = null;
    let topRevenueChart = null;
    
    // –î–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
    let analyticsData = {
        sales: null,
        products: null
    };
    
    // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–µ—Ä–∏–æ–¥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–º–µ—Å—è—Ü)
    function initAnalyticsDates() {
        const today = new Date();
        const monthAgo = new Date(today);
        monthAgo.setMonth(monthAgo.getMonth() - 1);
        
        document.getElementById('analyticsDateTo').value = today.toISOString().split('T')[0];
        document.getElementById('analyticsDateFrom').value = monthAgo.toISOString().split('T')[0];
    }
    
    // –ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä –ø–µ—Ä–∏–æ–¥–∞
    function setQuickPeriod(period) {
        const today = new Date();
        let dateFrom = new Date();
        
        // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
        document.querySelectorAll('.quick-period-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        switch (period) {
            case 'today':
                dateFrom = today;
                break;
            case 'week':
                dateFrom.setDate(today.getDate() - 7);
                break;
            case 'month':
                dateFrom.setMonth(today.getMonth() - 1);
                break;
            case 'quarter':
                dateFrom.setMonth(today.getMonth() - 3);
                break;
            case 'year':
                dateFrom.setFullYear(today.getFullYear() - 1);
                break;
            case 'all':
                document.getElementById('analyticsDateFrom').value = '';
                document.getElementById('analyticsDateTo').value = '';
                loadAnalyticsData();
                return;
        }
        
        document.getElementById('analyticsDateTo').value = today.toISOString().split('T')[0];
        document.getElementById('analyticsDateFrom').value = dateFrom.toISOString().split('T')[0];
        loadAnalyticsData();
    }
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–±–æ–≤ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
    function switchAnalyticsTab(tab) {
        document.querySelectorAll('.analytics-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.analytics-panel').forEach(p => p.classList.remove('active'));
        
        event.target.classList.add('active');
        document.getElementById(`${tab}-panel`).classList.add('active');
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
        if (tab === 'products' && !analyticsData.products) {
            loadProductsAnalytics();
        }
        if (tab === 'users') {
            loadUserActivityData();
        }
        if (tab === 'prices') {
            loadPriceAdjustCategories();
        }
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
    function loadAnalyticsData() {
        loadSalesAnalytics();
        loadProductsAnalytics();
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (SQL-–ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ v_user_activity)
    function loadUserActivityData() {
        fetch('/api/admin/analytics/user-activity/', {
            headers: { 'Authorization': `Token ${authToken}` }
        })
        .then(r => { if (!r.ok) throw new Error(); return r.json(); })
        .then(data => {
            const tbody = document.getElementById('userActivityTable');
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
                return;
            }
            tbody.innerHTML = data.map(u => `
                <tr>
                    <td>${u.userId}</td>
                    <td>${escapeHtml(u.fullName || '')}</td>
                    <td>${escapeHtml(u.email || '')}</td>
                    <td>${escapeHtml(u.role || '')}</td>
                    <td class="number">${u.orderCount}</td>
                    <td class="number">${Number(u.totalSpent).toLocaleString('ru-RU')} ‚ÇΩ</td>
                    <td class="number">${u.reviewCount}</td>
                    <td>${u.registeredAt ? new Date(u.registeredAt).toLocaleDateString('ru-RU') : ''}</td>
                </tr>
            `).join('');
        })
        .catch(() => {
            document.getElementById('userActivityTable').innerHTML = '<tr><td colspan="8" style="text-align: center; color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
        });
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ü–µ–Ω–∞–º–∏
    function loadPriceAdjustCategories() {
        fetch('/api/catalog/categories/')
        .then(r => r.json())
        .then(categories => {
            const sel = document.getElementById('priceAdjustCategory');
            sel.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>';
            categories.forEach(c => {
                sel.innerHTML += `<option value="${c.categoryId}">${escapeHtml(c.categoryName)}</option>`;
            });
        })
        .catch(() => {});
    }
    
    // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω (—Ö—Ä–∞–Ω–∏–º–∞—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ sp_adjust_prices_by_category)
    function applyPriceAdjustment() {
        const categoryId = document.getElementById('priceAdjustCategory').value;
        const percent = document.getElementById('priceAdjustPercent').value;
        const resultDiv = document.getElementById('priceAdjustResult');
        
        if (!categoryId) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é');
            return;
        }
        if (!percent || isNaN(percent)) {
            alert('–£–∫–∞–∂–∏—Ç–µ –ø—Ä–æ—Ü–µ–Ω—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è');
            return;
        }
        
        const categoryName = document.getElementById('priceAdjustCategory').selectedOptions[0].text;
        const action = parseFloat(percent) < 0 ? '—Å–∫–∏–¥–∫—É' : '–Ω–∞—Ü–µ–Ω–∫—É';
        if (!confirm(`–ü—Ä–∏–º–µ–Ω–∏—Ç—å ${action} ${Math.abs(percent)}% –∫–æ –≤—Å–µ–º —Ç–æ–≤–∞—Ä–∞–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ¬´${categoryName}¬ª?`)) {
            return;
        }
        
        fetch('/api/admin/price-adjustment/', {
            method: 'POST',
            headers: {
                'Authorization': `Token ${authToken}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ categoryId: parseInt(categoryId), percentChange: parseFloat(percent) })
        })
        .then(r => {
            if (!r.ok) return r.json().then(d => { throw new Error(d.detail || '–û—à–∏–±–∫–∞'); });
            return r.json();
        })
        .then(data => {
            resultDiv.style.display = 'block';
            resultDiv.style.background = '#d1fae5';
            resultDiv.style.border = '1px solid #10b981';
            resultDiv.innerHTML = `<strong>–£—Å–ø–µ—à–Ω–æ!</strong> ${data.message}`;
            document.getElementById('priceAdjustPercent').value = '';
        })
        .catch(err => {
            resultDiv.style.display = 'block';
            resultDiv.style.background = '#fee2e2';
            resultDiv.style.border = '1px solid #ef4444';
            resultDiv.innerHTML = `<strong>–û—à–∏–±–∫–∞:</strong> ${err.message}`;
        });
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ø—Ä–æ–¥–∞–∂
    function loadSalesAnalytics() {
        const dateFrom = document.getElementById('analyticsDateFrom').value;
        const dateTo = document.getElementById('analyticsDateTo').value;
        const groupBy = document.getElementById('analyticsGroupBy').value;
        
        let url = `/api/admin/analytics/sales/?group_by=${groupBy}`;
        if (dateFrom) url += `&date_from=${dateFrom}`;
        if (dateTo) url += `&date_to=${dateTo}`;
        
        fetch(url, {
            headers: { 'Authorization': `Token ${authToken}` }
        })
        .then(r => {
            if (!r.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
            return r.json();
        })
        .then(data => {
            analyticsData.sales = data;
            renderSalesAnalytics(data);
        })
        .catch(err => {
            console.error('Error loading sales analytics:', err);
        });
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤
    function loadProductsAnalytics() {
        const dateFrom = document.getElementById('analyticsDateFrom').value;
        const dateTo = document.getElementById('analyticsDateTo').value;
        
        let url = '/api/admin/analytics/products/';
        const params = [];
        if (dateFrom) params.push(`date_from=${dateFrom}`);
        if (dateTo) params.push(`date_to=${dateTo}`);
        if (params.length) url += '?' + params.join('&');
        
        fetch(url, {
            headers: { 'Authorization': `Token ${authToken}` }
        })
        .then(r => {
            if (!r.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
            return r.json();
        })
        .then(data => {
            analyticsData.products = data;
            renderProductsAnalytics(data);
        })
        .catch(err => {
            console.error('Error loading products analytics:', err);
        });
    }
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∏—Å–ª–∞
    function formatNumber(num) {
        return new Intl.NumberFormat('ru-RU').format(num);
    }
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∞–ª—é—Ç—ã
    function formatCurrency(num) {
        return new Intl.NumberFormat('ru-RU', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(num) + ' ‚ÇΩ';
    }
    
    // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ø—Ä–æ–¥–∞–∂
    function renderSalesAnalytics(data) {
        // –°–≤–æ–¥–∫–∞
        document.getElementById('analyticsTotalRevenue').textContent = formatCurrency(data.summary.total_revenue);
        document.getElementById('analyticsTotalOrders').textContent = formatNumber(data.summary.total_orders);
        document.getElementById('analyticsAvgCheck').textContent = formatCurrency(data.summary.avg_order_value);
        
        // –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–æ–¥–∞–∂ –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º
        const periodTable = document.getElementById('salesByPeriodTable');
        if (data.sales_by_period.length === 0) {
            periodTable.innerHTML = '<tr><td colspan="4" style="text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</td></tr>';
        } else {
            periodTable.innerHTML = data.sales_by_period.map(item => `
                <tr>
                    <td>${item.period || '‚Äî'}</td>
                    <td class="number">${formatCurrency(item.revenue)}</td>
                    <td class="number">${item.orders_count}</td>
                    <td class="number">${formatCurrency(item.avg_check)}</td>
                </tr>
            `).join('');
        }
        
        // –¢–∞–±–ª–∏—Ü–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
        const categoryTable = document.getElementById('salesByCategoryTable');
        if (data.sales_by_category.length === 0) {
            categoryTable.innerHTML = '<tr><td colspan="3" style="text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
        } else {
            categoryTable.innerHTML = data.sales_by_category.map(item => `
                <tr>
                    <td>${escapeHtml(item.category)}</td>
                    <td class="number">${formatNumber(item.total_sold)}</td>
                    <td class="number">${formatCurrency(item.revenue)}</td>
                </tr>
            `).join('');
        }
        
        // –ì—Ä–∞—Ñ–∏–∫–∏
        renderSalesChart(data.sales_by_period);
        renderCategoriesChart(data.sales_by_category);
        renderStatusChart(data.orders_by_status);
        renderPaymentChart(data.orders_by_payment);
    }
    
    // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤
    function renderProductsAnalytics(data) {
        // –¢–∞–±–ª–∏—Ü–∞ —Ç–æ–ø –ø—Ä–æ–¥–∞–≤–∞–µ–º—ã—Ö
        const topSellingTable = document.getElementById('topSellingTable');
        if (data.top_selling_products.length === 0) {
            topSellingTable.innerHTML = '<tr><td colspan="5" style="text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</td></tr>';
        } else {
            topSellingTable.innerHTML = data.top_selling_products.map((item, idx) => `
                <tr>
                    <td>${idx + 1}</td>
                    <td>${escapeHtml(item.product_name)}</td>
                    <td>${escapeHtml(item.category)}</td>
                    <td class="number">${formatNumber(item.total_sold)}</td>
                    <td class="number">${formatCurrency(item.revenue)}</td>
                </tr>
            `).join('');
        }
        
        // –¢–∞–±–ª–∏—Ü–∞ —Ç–æ–ø –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É
        const topRatedTable = document.getElementById('topRatedTable');
        if (data.top_rated_products.length === 0) {
            topRatedTable.innerHTML = '<tr><td colspan="5" style="text-align: center;">–ù–µ—Ç –æ—Ç–∑—ã–≤–æ–≤</td></tr>';
        } else {
            topRatedTable.innerHTML = data.top_rated_products.map((item, idx) => `
                <tr>
                    <td>${idx + 1}</td>
                    <td>${escapeHtml(item.product_name)}</td>
                    <td>${escapeHtml(item.category || '‚Äî')}</td>
                    <td class="number">${item.avg_rating.toFixed(1)} ‚≠ê</td>
                    <td class="number">${item.reviews_count}</td>
                </tr>
            `).join('');
        }
        
        // –¢–∞–±–ª–∏—Ü–∞ —Ç–æ–≤–∞—Ä–æ–≤ —Å –Ω–∏–∑–∫–∏–º –æ—Å—Ç–∞—Ç–∫–æ–º
        const lowStockTable = document.getElementById('lowStockTable');
        if (data.low_stock_products.length === 0) {
            lowStockTable.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #28a745;">–í—Å–µ —Ç–æ–≤–∞—Ä—ã –≤ –Ω–∞–ª–∏—á–∏–∏</td></tr>';
        } else {
            lowStockTable.innerHTML = data.low_stock_products.map(item => `
                <tr style="background: ${item.quantity === 0 ? '#fee2e2' : '#fef3c7'};">
                    <td>${item.product_id}</td>
                    <td>${escapeHtml(item.product_name)}</td>
                    <td>${escapeHtml(item.category || '‚Äî')}</td>
                    <td class="number" style="font-weight: 700; color: ${item.quantity === 0 ? '#dc2626' : '#92400e'};">${item.quantity}</td>
                    <td class="number">${formatCurrency(item.price)}</td>
                </tr>
            `).join('');
        }
        
        // –ì—Ä–∞—Ñ–∏–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤
        renderTopProductsChart(data.top_selling_products.slice(0, 10));
        renderTopRevenueChart(data.top_revenue_products.slice(0, 10));
    }
    
    // –¶–≤–µ—Ç–∞ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
    const chartColors = [
        '#dc2626', '#f97316', '#eab308', '#22c55e', '#14b8a6',
        '#3b82f6', '#8b5cf6', '#ec4899', '#64748b', '#06b6d4'
    ];
    
    // –ì—Ä–∞—Ñ–∏–∫ –¥–∏–Ω–∞–º–∏–∫–∏ –ø—Ä–æ–¥–∞–∂
    function renderSalesChart(data) {
        const ctx = document.getElementById('salesChart').getContext('2d');
        
        if (salesChart) salesChart.destroy();
        
        salesChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map(d => d.period),
                datasets: [{
                    label: '–í—ã—Ä—É—á–∫–∞',
                    data: data.map(d => d.revenue),
                    borderColor: '#dc2626',
                    backgroundColor: 'rgba(220, 38, 38, 0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: value => formatNumber(value) + ' ‚ÇΩ'
                        }
                    }
                }
            }
        });
    }
    
    // –ì—Ä–∞—Ñ–∏–∫ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    function renderCategoriesChart(data) {
        const ctx = document.getElementById('categoriesChart').getContext('2d');
        
        if (categoriesChart) categoriesChart.destroy();
        
        const topData = data.slice(0, 8);
        
        categoriesChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: topData.map(d => d.category),
                datasets: [{
                    data: topData.map(d => d.revenue),
                    backgroundColor: chartColors.slice(0, topData.length)
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: { boxWidth: 12, font: { size: 11 } }
                    }
                }
            }
        });
    }
    
    // –ì—Ä–∞—Ñ–∏–∫ —Å—Ç–∞—Ç—É—Å–æ–≤ –∑–∞–∫–∞–∑–æ–≤
    function renderStatusChart(data) {
        const ctx = document.getElementById('statusChart').getContext('2d');
        
        if (statusChart) statusChart.destroy();
        
        statusChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: data.map(d => d.status),
                datasets: [{
                    data: data.map(d => d.count),
                    backgroundColor: chartColors.slice(0, data.length)
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: { boxWidth: 12, font: { size: 11 } }
                    }
                }
            }
        });
    }
    
    // –ì—Ä–∞—Ñ–∏–∫ —Å–ø–æ—Å–æ–±–æ–≤ –æ–ø–ª–∞—Ç—ã
    function renderPaymentChart(data) {
        const ctx = document.getElementById('paymentChart').getContext('2d');
        
        if (paymentChart) paymentChart.destroy();
        
        paymentChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.map(d => d.payment_type),
                datasets: [{
                    label: '–ó–∞–∫–∞–∑–æ–≤',
                    data: data.map(d => d.count),
                    backgroundColor: chartColors.slice(0, data.length)
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }
    
    // –ì—Ä–∞—Ñ–∏–∫ —Ç–æ–ø —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º
    function renderTopProductsChart(data) {
        const ctx = document.getElementById('topProductsChart').getContext('2d');
        
        if (topProductsChart) topProductsChart.destroy();
        
        topProductsChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.map(d => d.product_name.length > 20 ? d.product_name.slice(0, 20) + '...' : d.product_name),
                datasets: [{
                    label: '–ü—Ä–æ–¥–∞–Ω–æ —à—Ç.',
                    data: data.map(d => d.total_sold),
                    backgroundColor: '#dc2626'
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: { beginAtZero: true }
                }
            }
        });
    }
    
    // –ì—Ä–∞—Ñ–∏–∫ —Ç–æ–ø —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –≤—ã—Ä—É—á–∫–µ
    function renderTopRevenueChart(data) {
        const ctx = document.getElementById('topRevenueChart').getContext('2d');
        
        if (topRevenueChart) topRevenueChart.destroy();
        
        topRevenueChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.map(d => d.product_name.length > 20 ? d.product_name.slice(0, 20) + '...' : d.product_name),
                datasets: [{
                    label: '–í—ã—Ä—É—á–∫–∞ ‚ÇΩ',
                    data: data.map(d => d.revenue),
                    backgroundColor: '#22c55e'
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            callback: value => formatNumber(value) + ' ‚ÇΩ'
                        }
                    }
                }
            }
        });
    }
    
    // –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á—ë—Ç–∞
    function exportReport(reportType, format) {
        const dateFrom = document.getElementById('analyticsDateFrom').value;
        const dateTo = document.getElementById('analyticsDateTo').value;
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ endpoints —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º export
        let url = `/api/admin/analytics/${reportType}/?export=${format}`;
        if (dateFrom) url += `&date_from=${dateFrom}`;
        if (dateTo) url += `&date_to=${dateTo}`;
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ fetch
        fetch(url, {
            headers: { 'Authorization': `Token ${authToken}` }
        })
        .then(response => {
            if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞');
            const contentType = response.headers.get('Content-Type') || '';
            console.log('Export Content-Type:', contentType);
            return response.arrayBuffer().then(buffer => ({ buffer, contentType }));
        })
        .then(({ buffer, contentType }) => {
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º MIME —Ç–∏–ø –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞
            let mimeType, ext;
            if (contentType.includes('spreadsheetml') || contentType.includes('excel')) {
                mimeType = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
                ext = 'xlsx';
            } else {
                mimeType = 'text/csv;charset=utf-8';
                ext = 'csv';
            }
            
            const blob = new Blob([buffer], { type: mimeType });
            const downloadUrl = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = downloadUrl;
            a.download = `${reportType}_report_${dateFrom || 'all'}_${dateTo || 'all'}.${ext}`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(downloadUrl);
            a.remove();
        })
        .catch(err => {
            console.error('Export error:', err);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –æ—Ç—á—ë—Ç–∞');
        });
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–∞–∑–¥–µ–ª–∞
    document.addEventListener('DOMContentLoaded', function() {
        initAnalyticsDates();
    });
    
    // =============================================
    // –ò–ú–ü–û–†–¢ / –≠–ö–°–ü–û–†–¢ –î–ê–ù–ù–´–•
    // =============================================
    
    function exportTableData() {
        const table = document.getElementById('exportTable').value;
        const format = document.getElementById('exportFormat').value;
        const url = `/api/admin/data-export/?table=${table}&file_format=${format}`;
        
        console.log('–ó–∞–ø—Ä–æ—Å –Ω–∞:', url);
        console.log('–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:', { table, format });
        console.log('–¢–æ–∫–µ–Ω:', authToken ? '–ü—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç' : '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç');
        
        fetch(url, {
            method: 'GET',
            headers: { 
                'Authorization': `Token ${authToken}`,
                'Accept': format === 'csv' ? 'text/csv' : 'application/sql'
            }
        })
        .then(response => {
            console.log('–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', response.status);
            console.log('URL –æ—Ç–≤–µ—Ç–∞:', response.url);
            
            if (response.status === 404) {
                throw new Error(`–†–µ—Å—É—Ä—Å –Ω–µ –Ω–∞–π–¥–µ–Ω (404). –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç—å: ${url}`);
            }
            
            if (!response.ok) {
                return response.text().then(text => {
                    console.error('–¢–µ–∫—Å—Ç –æ—à–∏–±–∫–∏:', text);
                    try {
                        const data = JSON.parse(text);
                        throw new Error(data.detail || data.message || `–û—à–∏–±–∫–∞ ${response.status}`);
                    } catch {
                        throw new Error(`–û—à–∏–±–∫–∞ ${response.status}: ${text}`);
                    }
                });
            }
            
            const contentDisposition = response.headers.get('Content-Disposition') || '';
            const filenameMatch = contentDisposition.match(/filename="?([^";\n]+)"?/);
            const filename = filenameMatch ? filenameMatch[1] : `${table}_export.${format === 'sql' ? 'sql' : 'csv'}`;
            
            return response.blob().then(blob => ({ blob, filename }));
        })
        .then(({ blob, filename }) => {
            console.log('–§–∞–π–ª –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è:', filename, '–†–∞–∑–º–µ—Ä:', blob.size);
            
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
            alert('–≠–∫—Å–ø–æ—Ä—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!');
        })
        .catch(err => {
            console.error('–ü–æ–ª–Ω–∞—è –æ—à–∏–±–∫–∞:', err);
            alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ: ${err.message}`);
        });
    }
    
    function importCsvData() {
        const table = document.getElementById('importTable').value;
        const fileInput = document.getElementById('importFile');
        const resultDiv = document.getElementById('importResult');
        
        if (!fileInput.files || !fileInput.files[0]) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ CSV-—Ñ–∞–π–ª –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞.');
            return;
        }
        
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('table', table);
        
        resultDiv.style.display = 'none';
        
        fetch('/api/admin/data-import/', {
            method: 'POST',
            headers: { 'Authorization': `Token ${authToken}` },
            body: formData
        })
        .then(r => r.json().then(body => ({ ok: r.ok, body })))
        .then(({ ok, body }) => {
            resultDiv.style.display = 'block';
            if (ok) {
                resultDiv.style.background = '#d1fae5';
                resultDiv.style.color = '#065f46';
                resultDiv.style.border = '1px solid #10b981';
                resultDiv.innerHTML = `<strong>–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω.</strong> ${escapeHtml(body.detail || '')}`;
                fileInput.value = '';
            } else {
                resultDiv.style.background = '#fee2e2';
                resultDiv.style.color = '#991b1b';
                resultDiv.style.border = '1px solid #ef4444';
                resultDiv.innerHTML = `<strong>–û—à–∏–±–∫–∞:</strong> ${escapeHtml(body.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞')}`;
            }
        })
        .catch(() => {
            resultDiv.style.display = 'block';
            resultDiv.style.background = '#fee2e2';
            resultDiv.style.color = '#991b1b';
            resultDiv.style.border = '1px solid #ef4444';
            resultDiv.innerHTML = '<strong>–û—à–∏–±–∫–∞:</strong> –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∏–º–ø–æ—Ä—Ç.';
        });
    }
</script>
{% endblock %}