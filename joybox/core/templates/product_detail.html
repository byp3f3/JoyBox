{% extends 'base.html' %}

{% block title %}Детали товара - JoyBox{% endblock %}

{% block extra_css %}
<style>
    .product-detail-page {
        padding: 30px 0;
        min-height: calc(100vh - 200px);
    }
    
    .product-detail-container {
        display: flex;
        gap: 30px;
        margin-bottom: 40px;
    }
    
    .product-images {
        flex: 1;
        max-width: 500px;
    }
    
    .main-image-container {
        height: 400px;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 20px;
        background: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .main-image {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }
    
    .thumbnail-images {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }
    
    .thumbnail-image {
        width: 80px;
        height: 80px;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.3s ease;
    }
    
    .thumbnail-image:hover,
    .thumbnail-image.active {
        border-color: var(--primary-color);
        transform: translateY(-3px);
    }
    
    .thumbnail-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .product-info {
        flex: 1;
    }
    
    .product-title {
        color: var(--text-dark);
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 15px;
    }
    
    .product-brand {
        color: var(--text-light);
        font-size: 18px;
        margin-bottom: 20px;
    }
    
    .product-price {
        font-size: 32px;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 20px;
    }
    
    .product-rating {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 1px solid #eee;
    }
    
    .rating-stars {
        color: #f59e0b;
        margin-right: 15px;
        font-size: 18px;
    }
    
    .rating-text {
        font-size: 16px;
        color: var(--text-light);
    }
    
    .product-meta {
        display: flex;
        gap: 20px;
        margin-bottom: 25px;
        padding-bottom: 25px;
        border-bottom: 1px solid #eee;
    }
    
    .meta-item {
        display: flex;
        flex-direction: column;
    }
    
    .meta-label {
        font-size: 14px;
        color: var(--text-light);
        margin-bottom: 5px;
    }
    
    .meta-value {
        font-weight: 600;
        font-size: 16px;
    }
    
    .product-description {
        margin-bottom: 30px;
    }
    
    .product-description h3 {
        color: var(--text-dark);
        font-size: 20px;
        margin-bottom: 15px;
    }
    
    .product-description p {
        color: var(--text-light);
        line-height: 1.6;
    }
    
    .product-attributes {
        margin-bottom: 30px;
    }
    
    .product-attributes h3 {
        color: var(--text-dark);
        font-size: 20px;
        margin-bottom: 15px;
    }
    
    .attributes-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
    }
    
    .attribute-item {
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }
    
    .attribute-name {
        font-weight: 600;
        margin-bottom: 5px;
        color: var(--text-dark);
    }
    
    .attribute-value {
        color: var(--text-light);
    }
    
    .add-to-cart-section {
        display: flex;
        gap: 16px;
        align-items: center;
        margin-top: 30px;
        flex-wrap: wrap;
    }
    
    .cart-block-inner {
        display: flex;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
    }
    
    .quantity-plaque {
        display: inline-flex;
        align-items: center;
        gap: 12px;
        padding: 8px 12px;
        background: var(--bg-content, #f8f9fa);
        border: 1px solid var(--border-muted, #e5e7eb);
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
    }
    
    .quantity-plaque-label {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-dark);
        white-space: nowrap;
    }
    
    .quantity-selector {
        display: inline-flex;
        align-items: center;
        border: 1px solid var(--border-muted, #ddd);
        border-radius: 10px;
        overflow: hidden;
        background: var(--bg-card, #fff);
    }
    
    .quantity-btn {
        width: 42px;
        height: 42px;
        background: var(--bg-content, #f1f5f9);
        border: none;
        font-size: 20px;
        font-weight: 600;
        color: var(--text-dark);
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
    }
    
    .quantity-btn:hover {
        background: var(--primary-color);
        color: white;
    }
    
    .quantity-input {
        width: 52px;
        height: 42px;
        border: none;
        border-left: 1px solid var(--border-muted, #e5e7eb);
        border-right: 1px solid var(--border-muted, #e5e7eb);
        text-align: center;
        font-size: 16px;
        font-weight: 600;
        background: var(--bg-card, #fff);
        color: var(--text-dark);
    }
    
    .quantity-input:focus {
        outline: none;
    }
    
    .quantity-input::-webkit-inner-spin-button,
    .quantity-input::-webkit-outer-spin-button {
        opacity: 1;
    }
    
    .btn-add-to-cart {
        flex: 1;
        background: linear-gradient(135deg, var(--primary-color), #b91c1c);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-add-to-cart:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
    }
    
    .btn-wishlist {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: #f1f5f9;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-wishlist:hover {
        background: #e2e8f0;
        transform: translateY(-2px);
    }
    
    .btn-wishlist.active {
        color: var(--primary-color);
    }
    
    .product-tabs {
        margin-top: 40px;
    }
    
    .tabs-header {
        display: flex;
        border-bottom: 1px solid #eee;
        margin-bottom: 20px;
    }
    
    .tab-button {
        padding: 15px 25px;
        background: none;
        border: none;
        font-weight: 600;
        color: var(--text-light);
        cursor: pointer;
        position: relative;
        transition: all 0.3s ease;
    }
    
    .tab-button.active {
        color: var(--primary-color);
    }
    
    .tab-button.active::after {
        content: '';
        position: absolute;
        bottom: -1px;
        left: 0;
        width: 100%;
        height: 3px;
        background: var(--primary-color);
        border-radius: 3px 3px 0 0;
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    .reviews-section h3 {
        color: var(--text-dark);
        font-size: 20px;
        margin-bottom: 20px;
    }
    
    .review-item {
        padding: 20px;
        border-bottom: 1px solid #eee;
    }
    
    .review-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
    }
    
    .review-author {
        font-weight: 600;
        color: var(--text-dark);
    }
    
    .review-date {
        color: var(--text-light);
        font-size: 14px;
    }
    
    .review-stars {
        color: #f59e0b;
        margin-bottom: 10px;
    }
    
    .review-text {
        color: var(--text-light);
        line-height: 1.6;
    }
    
    #write-review {
        margin-top: 28px;
        padding-top: 24px;
        border-top: 1px solid #eee;
    }
    #write-review h4 { font-size: 18px; margin-bottom: 16px; color: var(--text-dark); }
    .write-review-form .form-group { margin-bottom: 16px; }
    .write-review-form label { display: block; margin-bottom: 6px; font-weight: 600; color: var(--text-dark); }
    .write-review-form textarea { width: 100%; min-height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
    .write-review-form .rating-stars-input { display: flex; gap: 6px; margin-top: 6px; }
    .write-review-form .rating-stars-input i { font-size: 24px; color: #ddd; cursor: pointer; }
    .write-review-form .rating-stars-input i.active { color: #f59e0b; }
    .write-review-form .btn-submit-review { padding: 10px 24px; background: var(--primary-color); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
    .write-review-form .btn-submit-review:hover { opacity: 0.9; }
    .write-review-already { color: var(--text-light); padding: 12px 0; }
    .write-review-already .review-item { border: none; padding: 12px 0; }
    .btn-edit-review { margin-top: 12px; padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
    .btn-edit-review:hover { opacity: 0.9; }
    
    .loading-container {
        text-align: center;
        padding: 50px 20px;
    }
    
    .loading-spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-left-color: var(--primary-color);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }
    
    .error-container {
        text-align: center;
        padding: 50px 20px;
        color: #e74c3c;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    @media (max-width: 992px) {
        .product-detail-container {
            flex-direction: column;
        }
        
        .product-images {
            max-width: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="product-detail-page container" data-product-id="{{ product_id }}">
    <div class="loading-container" id="loadingContainer">
        <div class="loading-spinner"></div>
        <p>Загрузка информации о товаре...</p>
    </div>
    
    <div class="error-container" id="errorContainer" style="display: none;">
        <p>Ошибка загрузки информации о товаре. Пожалуйста, попробуйте позже.</p>
    </div>
    
    <div class="product-detail-container" id="productContainer" style="display: none;">
        <div class="product-images">
            <div class="main-image-container">
                <img id="mainImage" class="main-image" src="" alt="">
            </div>
            <div class="thumbnail-images" id="thumbnailImages">
                <!-- Миниатюры будут заполнены JavaScript -->
            </div>
        </div>
        
        <div class="product-info">
            <h1 class="product-title" id="productName"></h1>
            <div class="product-brand" id="productBrand"></div>
            
            <div class="product-rating">
                <div class="rating-stars" id="productStars"></div>
                <div class="rating-text" id="productRatingText"></div>
            </div>
            
            <div class="product-price" id="productPrice"></div>
            
            <div class="product-meta">
                <div class="meta-item">
                    <div class="meta-label">Возраст</div>
                    <div class="meta-value" id="productAge"></div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Вес</div>
                    <div class="meta-value" id="productWeight"></div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Размеры</div>
                    <div class="meta-value" id="productDimensions"></div>
                </div>
            </div>
            
            <div class="product-description">
                <h3>Описание</h3>
                <p id="productDescription"></p>
            </div>
            
            <div class="product-attributes">
                <h3>Характеристики</h3>
                <div class="attributes-list" id="productAttributes">
                    <!-- Характеристики будут заполнены JavaScript -->
                </div>
            </div>
            
            <div class="add-to-cart-section">
                <div id="cartBlock" class="cart-block-inner">
                    <div class="quantity-plaque">
                        <span class="quantity-plaque-label">Количество</span>
                        <div class="quantity-selector">
                            <button type="button" class="quantity-btn" onclick="decreaseQuantity()" aria-label="Уменьшить">−</button>
                            <input type="number" class="quantity-input" id="quantityInput" value="1" min="1" max="99" aria-label="Количество">
                            <button type="button" class="quantity-btn" onclick="increaseQuantity()" aria-label="Увеличить">+</button>
                        </div>
                    </div>
                    <button type="button" class="btn-add-to-cart" onclick="addToCart()">Добавить в корзину</button>
                </div>
                <button type="button" class="btn-wishlist" id="wishlistButton" onclick="toggleWishlist()" title="Добавить в список желаний">
                    <i class="far fa-heart"></i>
                </button>
            </div>
        </div>
    </div>
    
    <div class="product-tabs">
        <div class="tabs-header">
            <button class="tab-button active" onclick="showTab('reviews')">Отзывы</button>
            <button class="tab-button" onclick="showTab('description')">Описание</button>
            <button class="tab-button" onclick="showTab('attributes')">Характеристики</button>
        </div>
        
        <div class="tab-content active" id="reviewsTab">
            <div class="reviews-section">
                <h3>Отзывы покупателей</h3>
                <div id="reviewsContainer">
                    <!-- Отзывы будут заполнены JavaScript -->
                </div>
                <div id="write-review" style="display: none;">
                    <h4>Написать отзыв</h4>
                    <div id="writeReviewContent"></div>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="descriptionTab">
            <div class="product-description">
                <h3>Подробное описание</h3>
                <p id="detailedDescription"></p>
            </div>
        </div>
        
        <div class="tab-content" id="attributesTab">
            <div class="product-attributes">
                <h3>Полные характеристики</h3>
                <div class="attributes-list" id="detailedAttributes">
                    <!-- Характеристики будут заполнены JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentProduct = null;
    let currentWishlistId = null;
    const authToken = typeof localStorage !== 'undefined' ? localStorage.getItem('authToken') : null;
    
    // Загрузка данных о товаре
    async function loadProduct() {
        // Получить ID товара из data-атрибута
        const productContainer = document.querySelector('.product-detail-page');
        const productId = productContainer.dataset.productId;
        
        const loadingContainer = document.getElementById('loadingContainer');
        const errorContainer = document.getElementById('errorContainer');
        const productDetailContainer = document.getElementById('productContainer');
        
        try {
            const response = await fetch(`/api/catalog/products/${productId}/`);
            if (!response.ok) {
                throw new Error('Product not found');
            }
            
            const product = await response.json();
            currentProduct = product;
            
            // Скрыть загрузку, показать товар
            loadingContainer.style.display = 'none';
            errorContainer.style.display = 'none';
            productDetailContainer.style.display = 'flex';
            
            // Заполнить данные товара
            populateProductData(product);
            // Для ребёнка скрыть корзину; обновить состояние кнопки «В желания»
            checkUserRoleAndWishlist();
        } catch (error) {
            console.error('Error loading product:', error);
            loadingContainer.style.display = 'none';
            errorContainer.style.display = 'block';
            productDetailContainer.style.display = 'none';
        }
    }
    
    async function checkUserRoleAndWishlist() {
        const addToCartSection = document.querySelector('.add-to-cart-section');
        const cartBlock = document.getElementById('cartBlock');
        const wishlistBtn = document.getElementById('wishlistButton');
        if (!authToken) {
            if (addToCartSection) addToCartSection.style.display = 'none';
            return;
        }
        if (!cartBlock || !wishlistBtn) return;
        try {
            const profileRes = await fetch('/api/auth/profile/', { headers: { 'Authorization': 'Token ' + authToken } });
            if (profileRes.ok) {
                const profile = await profileRes.json();
                if (profile.roleName === 'Ребенок') {
                    cartBlock.style.display = 'none';
                }
                if (profile.roleName === 'Покупатель') {
                    const wb = document.getElementById('wishlistButton');
                    if (wb) wb.style.display = 'none';
                }
            }
            const wishlistRes = await fetch('/api/auth/wishlist/', { headers: { 'Authorization': 'Token ' + authToken } });
            if (wishlistRes.ok) {
                const list = await wishlistRes.json();
                const productId = currentProduct && (currentProduct.productId || currentProduct.id);
                const item = Array.isArray(list) ? list.find(function (x) { return (x.product && (x.product.productId || x.product.id)) === productId; }) : null;
                currentWishlistId = item ? item.wishlistId : null;
                const icon = wishlistBtn.querySelector('i');
                if (currentWishlistId) {
                    wishlistBtn.classList.add('active');
                    if (icon) icon.className = 'fas fa-heart';
                    wishlistBtn.title = 'Удалить из списка желаний';
                } else {
                    wishlistBtn.classList.remove('active');
                    if (icon) icon.className = 'far fa-heart';
                    wishlistBtn.title = 'Добавить в список желаний';
                }
            }
        } catch (e) { console.error(e); }
    }
    
    // Заполнение данных товара
    function populateProductData(product) {
        const safe = (v, def) => (v != null && v !== '' ? v : def);
        const brandName = product.brand ? (product.brand.brandName || product.brand) : '';

        // Основная информация
        document.getElementById('productName').textContent = safe(product.productName, 'Товар');
        document.getElementById('productBrand').textContent = brandName;
        document.getElementById('productPrice').textContent = `${Number(product.price || 0).toLocaleString('ru-RU')} руб.`;
        document.getElementById('productDescription').textContent = safe(product.productDescription, '');
        document.getElementById('detailedDescription').textContent = safe(product.productDescription, '');

        // Рейтинг
        const starsHtml = renderStars(product.average_rating);
        document.getElementById('productStars').innerHTML = starsHtml;
        document.getElementById('productRatingText').textContent = `${product.average_rating != null ? Number(product.average_rating).toFixed(1) : 'Нет оценок'} (${product.review_count || 0} отзывов)`;

        // Метаданные
        document.getElementById('productAge').textContent = `${product.ageRating != null ? product.ageRating : 0}+ лет`;
        document.getElementById('productWeight').textContent = product.weightKg != null ? `${product.weightKg} кг` : '—';
        document.getElementById('productDimensions').textContent = safe(product.dimensions, '—');

        // Изображения
        const images = Array.isArray(product.images) ? product.images : [];
        if (images.length > 0) {
            const mainImage = product.main_image && product.main_image.url ? product.main_image : images[0];
            const mainUrl = mainImage && mainImage.url ? mainImage.url : '';
            const mainAlt = mainImage && mainImage.altText != null ? String(mainImage.altText) : '';
            document.getElementById('mainImage').src = mainUrl;
            document.getElementById('mainImage').alt = mainAlt;

            const thumbnailContainer = document.getElementById('thumbnailImages');
            thumbnailContainer.innerHTML = images.map(image => {
                const url = image && image.url ? image.url : '';
                const alt = image && image.altText != null ? String(image.altText).replace(/'/g, '&#39;') : '';
                return `<div class="thumbnail-image" onclick="changeMainImage('${url.replace(/'/g, "\\'")}', '${alt}')"><img src="${url}" alt="${alt}"></div>`;
            }).join('');

            if (thumbnailContainer.firstChild) {
                thumbnailContainer.firstChild.classList.add('active');
            }
        } else {
            document.getElementById('mainImage').src = '';
            document.getElementById('mainImage').alt = 'Нет изображения';
            document.getElementById('thumbnailImages').innerHTML = '';
        }

        // Характеристики
        const attributesContainer = document.getElementById('productAttributes');
        const detailedAttributesContainer = document.getElementById('detailedAttributes');
        const attrs = Array.isArray(product.attributes) ? product.attributes : [];

        if (attrs.length > 0) {
            const attrRow = (attr) => {
                const name = attr && attr.productAttributeName != null ? attr.productAttributeName : '';
                const value = attr && attr.productAttributeValue != null ? attr.productAttributeValue : '';
                const unit = attr && attr.productAttributeUnit ? ` ${attr.productAttributeUnit}` : '';
                return `<div class="attribute-item"><div class="attribute-name">${name}</div><div class="attribute-value">${value}${unit}</div></div>`;
            };
            attributesContainer.innerHTML = attrs.slice(0, 4).map(attrRow).join('');
            detailedAttributesContainer.innerHTML = attrs.map(attrRow).join('');
        } else {
            attributesContainer.innerHTML = '<p>Характеристики не указаны</p>';
            detailedAttributesContainer.innerHTML = '<p>Характеристики не указаны</p>';
        }

        if (product.productId != null) {
            loadProductReviews(product.productId);
            if (authToken) {
                loadMyReviewAndShowForm(product.productId);
            }
        }
        if (window.location.hash === '#write-review') {
            setTimeout(() => {
                const el = document.getElementById('write-review');
                if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 300);
        }
    }
    
    // Загрузка отзывов о товаре
    async function loadProductReviews(productId) {
        try {
            const response = await fetch(`/api/catalog/products/${productId}/reviews/`);
            if (!response.ok) {
                throw new Error('Failed to load reviews');
            }
            
            const reviews = await response.json();
            displayReviews(reviews);
        } catch (error) {
            console.error('Error loading reviews:', error);
            const reviewsContainer = document.getElementById('reviewsContainer');
            reviewsContainer.innerHTML = '<p>Ошибка загрузки отзывов. Пожалуйста, попробуйте позже.</p>';
        }
    }
    
    // Загрузка отзыва текущего пользователя и показ формы или «уже оставлен отзыв»
    async function loadMyReviewAndShowForm(productId) {
        const block = document.getElementById('write-review');
        const content = document.getElementById('writeReviewContent');
        if (!block || !content) return;
        try {
            const response = await fetch(`/api/auth/reviews/?product_id=${productId}`, {
                headers: { 'Authorization': 'Token ' + authToken }
            });
            if (response.status === 403) {
                block.style.display = 'none';
                return;
            }
            const myReviews = await response.json().catch(() => []);
            block.style.display = 'block';
            if (myReviews && myReviews.length > 0) {
                const currentMyReview = myReviews[0];
                const r = currentMyReview;
                const safeText = (r.reviewText || 'Без комментариев').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                content.innerHTML = '<div class="write-review-already"><p>Вы уже оставили отзыв:</p><div class="review-item"><div class="review-stars">' + renderStars(r.rating) + '</div><div class="review-text">' + safeText + '</div></div><button type="button" class="btn-edit-review">Редактировать отзыв</button></div>';
                content.querySelector('.btn-edit-review').addEventListener('click', function() {
                    renderWriteReviewForm(productId, content, currentMyReview);
                });
                return;
            }
            renderWriteReviewForm(productId, content, null);
        } catch (e) {
            block.style.display = 'none';
        }
    }
    
    function renderWriteReviewForm(productId, container, existingReview) {
        const isEdit = existingReview && existingReview.reviewId;
        const initialRating = (existingReview && existingReview.rating) || 0;
        const initialText = (existingReview && existingReview.reviewText) || '';
        const escapeForTextarea = (s) => String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;');
        container.innerHTML = '<form class="write-review-form" id="writeReviewForm" data-review-id="' + (isEdit ? existingReview.reviewId : '') + '">' +
            '<div class="form-group"><label>Оценка</label><div class="rating-stars-input" id="ratingStarsInput" data-rating="' + initialRating + '">' +
            [1,2,3,4,5].map(i => '<i class="' + (i <= initialRating ? 'fas' : 'far') + ' fa-star' + (i <= initialRating ? ' active' : '') + '" data-value="' + i + '"></i>').join('') + '</div></div>' +
            '<div class="form-group"><label>Текст отзыва (необязательно)</label><textarea name="reviewText" id="reviewTextInput" placeholder="Напишите ваш отзыв...">' + escapeForTextarea(initialText) + '</textarea></div>' +
            '<button type="submit" class="btn-submit-review">' + (isEdit ? 'Сохранить изменения' : 'Отправить отзыв') + '</button></form>';
        const starsEl = document.getElementById('ratingStarsInput');
        let chosenRating = initialRating;
        if (starsEl) {
            starsEl.querySelectorAll('i').forEach(star => {
                star.addEventListener('mouseenter', function() {
                    const v = parseInt(this.dataset.value, 10);
                    starsEl.querySelectorAll('i').forEach((s, i) => {
                        s.classList.toggle('active', i < v);
                        s.classList.toggle('fas', i < v);
                        s.classList.toggle('far', i >= v);
                    });
                });
                star.addEventListener('mouseleave', function() {
                    starsEl.querySelectorAll('i').forEach((s, i) => {
                        const v = parseInt(s.dataset.value, 10);
                        s.classList.toggle('active', v <= chosenRating);
                        s.classList.toggle('fas', v <= chosenRating);
                        s.classList.toggle('far', v > chosenRating);
                    });
                });
                star.addEventListener('click', function() {
                    chosenRating = parseInt(this.dataset.value, 10);
                    starsEl.dataset.rating = chosenRating;
                    starsEl.querySelectorAll('i').forEach((s, i) => {
                        const v = parseInt(s.dataset.value, 10);
                        s.classList.toggle('active', v <= chosenRating);
                        s.classList.toggle('fas', v <= chosenRating);
                        s.classList.toggle('far', v > chosenRating);
                    });
                });
            });
        }
        document.getElementById('writeReviewForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (chosenRating < 1 || chosenRating > 5) {
                alert('Выберите оценку от 1 до 5.');
                return;
            }
            const text = (document.getElementById('reviewTextInput') && document.getElementById('reviewTextInput').value) || '';
            const form = document.getElementById('writeReviewForm');
            const reviewId = form && form.dataset && form.dataset.reviewId;
            const isEdit = !!reviewId;
            const url = isEdit ? ('/api/auth/reviews/' + reviewId + '/') : '/api/auth/reviews/';
            const method = isEdit ? 'PUT' : 'POST';
            const body = isEdit ? { rating: chosenRating, reviewText: text } : { productId: parseInt(productId, 10), rating: chosenRating, reviewText: text };
            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Token ' + authToken },
                    body: JSON.stringify(body)
                });
                const data = await res.json().catch(() => ({}));
                if (res.ok) {
                    if (currentProduct && currentProduct.productId) loadProductReviews(currentProduct.productId);
                    loadMyReviewAndShowForm(productId);
                    alert(isEdit ? 'Отзыв сохранён.' : 'Спасибо! Ваш отзыв опубликован.');
                    return;
                }
                const msg = (data.reviewText && data.reviewText[0]) || (data.detail && (typeof data.detail === 'string' ? data.detail : data.detail[0])) || 'Не удалось отправить отзыв.';
                alert(msg);
            } catch (err) {
                alert('Ошибка при отправке отзыва.');
            }
        });
    }
    
    // Отображение отзывов
    function displayReviews(reviews) {
        const reviewsContainer = document.getElementById('reviewsContainer');
        
        if (reviews.length === 0) {
            reviewsContainer.innerHTML = '<p>Отзывы пока отсутствуют. Будьте первым, кто оставит отзыв!</p>';
            return;
        }
        
        reviewsContainer.innerHTML = reviews.map(review => `
            <div class="review-item">
                <div class="review-header">
                    <div class="review-author">${review.user.firstName} ${review.user.lastName}</div>
                    <div class="review-date">${new Date(review.createdAt).toLocaleDateString('ru-RU')}</div>
                </div>
                <div class="review-stars">
                    ${renderStars(review.rating)}
                </div>
                <div class="review-text">
                    ${review.reviewText || 'Без комментариев'}
                </div>
            </div>
        `).join('');
    }
    
    // Отрисовка рейтинга звёздами
    function renderStars(rating) {
        if (!rating) return '<i class="far fa-star"></i>'.repeat(5);
        
        const fullStars = Math.floor(rating);
        const hasHalfStar = rating % 1 >= 0.5;
        let starsHtml = '';
        
        // Полные звёзды
        for (let i = 0; i < fullStars; i++) {
            starsHtml += '<i class="fas fa-star"></i>';
        }
        
        // Полу-звезда
        if (hasHalfStar) {
            starsHtml += '<i class="fas fa-star-half-alt"></i>';
        }
        
        // Пустые звёзды
        const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
        for (let i = 0; i < emptyStars; i++) {
            starsHtml += '<i class="far fa-star"></i>';
        }
        
        return starsHtml;
    }
    
    // Смена основного изображения
    function changeMainImage(url, altText) {
        document.getElementById('mainImage').src = url;
        document.getElementById('mainImage').alt = altText;
        
        // Обновить активную миниатюру
        const thumbnails = document.querySelectorAll('.thumbnail-image');
        thumbnails.forEach(thumb => thumb.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }
    
    // Управление количеством
    function increaseQuantity() {
        const input = document.getElementById('quantityInput');
        input.value = Math.min(parseInt(input.value) + 1, 99);
    }
    
    function decreaseQuantity() {
        const input = document.getElementById('quantityInput');
        input.value = Math.max(parseInt(input.value) - 1, 1);
    }
    
    // Add to cart (не показывается ребёнку)
    async function addToCart() {
        if (!authToken) {
            alert('Войдите в аккаунт, чтобы добавлять товары в корзину.');
            return;
        }
        if (!currentProduct) return;
        const productId = currentProduct.productId || currentProduct.id;
        const quantity = Math.max(1, parseInt(document.getElementById('quantityInput').value, 10) || 1);
        try {
            const res = await fetch('/api/auth/cart/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Token ' + authToken },
                body: JSON.stringify({ productId: Number(productId), quantity: quantity })
            });
            const data = await res.json().catch(() => ({}));
            if (res.ok) {
                alert('Товар добавлен в корзину' + (quantity > 1 ? ' в количестве ' + quantity + ' шт.' : '') + '.');
                return;
            }
            const msg = (data.quantity && data.quantity[0]) || (data.detail && (typeof data.detail === 'string' ? data.detail : JSON.stringify(data.detail))) || 'Не удалось добавить в корзину';
            if (res.status === 403) alert('Корзина доступна только покупателям.');
            else alert(msg);
        } catch (e) {
            console.error(e);
            alert('Ошибка при добавлении в корзину.');
        }
    }
    
    // Добавить/удалить из списка желаний (через API)
    async function toggleWishlist() {
        if (!authToken) {
            alert('Войдите в аккаунт, чтобы добавлять товары в список желаний.');
            return;
        }
        if (!currentProduct) return;
        const productId = currentProduct.productId || currentProduct.id;
        const button = document.getElementById('wishlistButton');
        const icon = button && button.querySelector('i');
        try {
            if (currentWishlistId) {
                const res = await fetch('/api/auth/wishlist/' + currentWishlistId + '/', {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Token ' + authToken }
                });
                if (res.ok) {
                    currentWishlistId = null;
                    if (button) button.classList.remove('active');
                    if (icon) icon.className = 'far fa-heart';
                    if (button) button.title = 'Добавить в список желаний';
                    alert('Товар удалён из списка желаний.');
                } else {
                    alert('Не удалось удалить из списка желаний.');
                }
            } else {
                const res = await fetch('/api/auth/wishlist/add/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Token ' + authToken },
                    body: JSON.stringify({ productId: Number(productId) })
                });
                let data = null;
                try { data = await res.json(); } catch (e) {}
                if (res.ok && data && data.wishlistId) {
                    currentWishlistId = data.wishlistId;
                    if (button) button.classList.add('active');
                    if (icon) icon.className = 'fas fa-heart';
                    if (button) button.title = 'Удалить из списка желаний';
                    alert('Товар добавлен в список желаний.');
                } else {
                    let msg = 'Не удалось добавить в список желаний.';
                    if (data) {
                        if (typeof data.detail === 'string') msg = data.detail;
                        else if (data.productId && Array.isArray(data.productId)) msg = data.productId[0];
                        else if (data.productId && typeof data.productId[0] === 'string') msg = data.productId[0];
                    }
                    if (res.status === 401) msg = 'Войдите в аккаунт, чтобы добавлять в список желаний.';
                    alert(msg);
                }
            }
        } catch (e) {
            console.error(e);
            alert('Ошибка при изменении списка желаний.');
        }
    }
    
    // Переключение вкладок
    function showTab(tabName) {
        // Скрыть все вкладки
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Убрать класс active у всех кнопок
        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('active');
        });
        
        // Показать выбранную вкладку
        document.getElementById(`${tabName}Tab`).classList.add('active');
        
        // Отметить кнопку как активную
        event.currentTarget.classList.add('active');
    }
    
    // Инициализация
    document.addEventListener('DOMContentLoaded', function() {
        loadProduct();
    });
</script>
{% endblock %}