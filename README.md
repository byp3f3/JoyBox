# JoyBox — Интернет-магазин детских игрушек

Полнофункциональный веб-магазин детских игрушек на Django + Django REST Framework с PostgreSQL.

---

## Содержание

1. [Архитектура](#архитектура)
2. [Стек технологий](#стек-технологий)
3. [Структура проекта](#структура-проекта)
4. [Роли и права доступа](#роли-и-права-доступа)
5. [База данных](#база-данных)
6. [Запуск локально](#запуск-локально)
7. [Запуск в Docker-контейнерах](#запуск-в-docker-контейнерах)

---

## Архитектура

**Принцип работы:**

1. **Клиент** (браузер) отправляет HTTP-запросы к серверу.
2. **Django** обрабатывает маршрутизацию (`urls.py`), передаёт запрос в соответствующую **View**.
3. **Django REST Framework** сериализует/десериализует данные, выполняет валидацию, проверяет аутентификацию (Token) и права доступа (роли).
4. **Models** (`managed = False`) обращаются к PostgreSQL — схема БД создаётся и управляется SQL-скриптом `create_database.sql`, а не Django-миграциями.
5. **PostgreSQL** выполняет бизнес-логику через хранимые процедуры, записывает аудит через триггеры, предоставляет аналитику через представления (VIEW).

---

## Стек технологий

| Компонент | Технология | Версия |
|---|---|---|
| Backend | Django | 5.2 |
| REST API | Django REST Framework | 3.16 |
| База данных | PostgreSQL | 17 |
| Аутентификация | Token Authentication (DRF) | — |
| Конфигурация | python-decouple (.env) | 3.8 |
| Изображения | Pillow | 12.0 |
| Импорт/Экспорт | openpyxl, csv | — |
| Нагрузочные тесты | Locust + Faker | — |
| Frontend | Django Templates + Vanilla JS | — |

---

## Структура проекта

```
JoyBox/
├── create_database.sql          # SQL-скрипт создания БД (таблицы, представления,
│                                #   процедуры, триггеры, начальные данные)
├── requirements.txt             # Python-зависимости
├── README.md                    # Этот файл
├── .gitignore
│
├── scripts/                     # Скрипты резервного копирования
│   ├── backup.bat / backup.sh
│   └── restore.bat / restore.sh
│
└── joybox/                      # Django-проект
    ├── .env.example             # Шаблон переменных окружения
    ├── manage.py
    ├── locustfile.py            # Нагрузочное тестирование (Locust)
    │
    ├── joybox/                  # Настройки проекта
    │   ├── settings.py
    │   ├── urls.py
    │   └── wsgi.py / asgi.py
    │
    └── core/                    # Основное приложение
        ├── models.py            # Модели (managed=False)
        ├── views.py             # API-вьюхи
        ├── serializers.py       # Сериализаторы DRF
        ├── urls.py              # Маршрутизация
        ├── audit.py             # Аудит-логирование
        ├── exceptions.py        # Обработка ошибок API
        ├── tests.py             # Unit/интеграционные тесты
        ├── test_runner.py       # Кастомный тест-раннер
        ├── templates/           # HTML-шаблоны
        ├── static/              # Статические файлы
        └── management/commands/ # Команды manage.py
            ├── backup_db.py
            └── restore_db.py
```

---

## Роли и права доступа

В системе 4 роли с различными уровнями доступа:

| Роль | Описание | Доступ |
|---|---|---|
| **Покупатель** | Основной пользователь магазина | Каталог, корзина, заказы, отзывы, избранное, адресная книга, профиль |
| **Ребенок** | Дочерний аккаунт покупателя | Каталог, избранное, профиль (без корзины и заказов) |
| **Менеджер** | Сотрудник магазина | Админ-панель: управление товарами, заказами, отзывами |
| **Администратор** | Полный доступ | Всё вышеперечисленное + управление пользователями, аудит, резервное копирование, импорт/экспорт, аналитика, изменение цен |

**Аутентификация:** Token-based (DRF `authtoken`). Токен выдаётся при регистрации или входе и передаётся в заголовке `Authorization: Token <key>`.

---

## База данных

Схема БД создаётся SQL-скриптом `create_database.sql`. Django-модели используют `managed = False` — миграции не управляют структурой таблиц.

### Таблицы (16 сущностей)

| Таблица | Описание |
|---|---|
| `role` | Справочник ролей |
| `user` | Пользователи (расширяет Django AbstractUser) |
| `category` | Категории товаров |
| `brand` | Бренды |
| `product` | Товары |
| `productImage` | Изображения товаров |
| `productAttribute` | Характеристики товаров |
| `address` | Адреса доставки |
| `orderStatus` | Статусы заказов |
| `order` | Заказы |
| `orderItem` | Позиции заказов |
| `review` | Отзывы |
| `wishlist` | Избранное |
| `cart` | Корзина |
| `parentChild` | Связь родитель-ребёнок |
| `auditLog` | Журнал аудита |

### Представления (VIEW)

| Представление | Назначение |
|---|---|
| `v_product_catalog` | Каталог товаров с категорией, брендом и средней оценкой |
| `v_order_details` | Детали заказов с информацией о покупателе |
| `v_sales_report` | Отчёт по продажам по месяцам |
| `v_user_activity` | Активность пользователей (заказы, отзывы, траты) |
| `v_popular_products` | Топ товаров по объёму продаж |

### Хранимые процедуры

| Процедура | Назначение |
|---|---|
| `sp_create_order_from_cart` | Создание заказа из корзины, обновление остатков, очистка корзины |
| `sp_cancel_order` | Отмена заказа, возврат товаров на склад |
| `sp_adjust_prices_by_category` | Пакетное изменение цен по категории (скидка/наценка) |

### Триггеры и функции

| Триггер / Функция | Таблица | Назначение |
|---|---|---|
| `fn_audit_log` + `trg_product_audit` | `product` | Аудит изменений товаров |
| `fn_audit_log` + `trg_order_audit` | `order` | Аудит изменений заказов |
| `fn_audit_log` + `trg_user_audit` | `user` | Аудит изменений пользователей |
| `fn_review_update_timestamp` + `trg_review_updated_at` | `review` | Автообновление `updatedAt` |

---

## Запуск локально

### Предварительные требования

- **Python** 3.11+
- **PostgreSQL** 17 (с утилитами `psql`, `pg_dump`, `pg_restore` в PATH)
- **Git**

### Шаг 1. Клонирование репозитория

```bash
git clone <url-репозитория>
cd JoyBox
```

### Шаг 2. Создание виртуального окружения

```bash
python -m venv .venv

# Windows (PowerShell):
.venv\Scripts\Activate.ps1

# Linux / macOS:
source .venv/bin/activate
```

### Шаг 3. Установка зависимостей

```bash
pip install -r requirements.txt
```

### Шаг 4. Настройка переменных окружения

```bash
cd joybox
cp .env.example .env
```

Отредактируйте `.env`, указав свои данные подключения к PostgreSQL:

```env
SECRET_KEY=ваш-секретный-ключ
DEBUG=True
DB_NAME=joybox
DB_USER=postgres
DB_PASSWORD=ваш-пароль
DB_HOST=127.0.0.1
DB_PORT=5432
PG_BIN_PATH=C:\Program Files\PostgreSQL\17\bin
```

### Шаг 5. Создание базы данных

Откройте **pgAdmin** или `psql` и выполните скрипт `create_database.sql`:

```bash
# Через psql:
psql -U postgres -f ../create_database.sql
```

Либо откройте `create_database.sql` в pgAdmin → Query Tool и выполните.

### Шаг 6. Применение миграций Django

```bash
python manage.py migrate
```

> Миграции создают служебные таблицы Django (сессии, токены, права). Основные таблицы уже созданы SQL-скриптом.

### Шаг 7. Запуск сервера

```bash
python manage.py runserver
```

Откройте в браузере: **http://127.0.0.1:8000**

---

## Запуск в Docker-контейнерах

В корне проекта уже есть `Dockerfile` и `docker-compose.yml`.

### Запуск

```bash
docker-compose up --build
```

Приложение доступно по адресу **http://localhost:8000**.

> При первом запуске PostgreSQL автоматически выполнит `create_database.sql`, а Django применит миграции для служебных таблиц.

### Остановка

```bash
docker-compose down          # остановить
docker-compose down -v       # остановить и удалить данные БД
```
